<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Info Scan — v6.5</title>

<style>
  :root{
    --bg: #D20014;
    --text: #111;
    --muted: #555;

    --weight-green: #059669;
    --weight-yellow: #CA8A04;
    --weight-red: #B91C1C;
  }

  body{
    background: var(--bg);
    color: var(--text);
    font-family: Arial, monospace;
    margin: 0;
    padding: 16px;
  }

  h1{
    color: white;
    font-size: 22px;
    margin: 10px 0 20px 0;
    font-weight: 900;
  }

  .card{
    background: #fff;
    border-radius: 14px;
    padding: 16px;
    margin-bottom: 20px;
  }

  /* Camera preview */
  #cameraWrap{
    background:#f3f4f6;
    border-radius:8px;
    height:260px;
    display:flex;
    align-items:center;
    justify-content:center;
    color:#9ca3af;
    overflow:hidden;
  }

  #cameraWrap video{
    width:100%;
    height:100%;
    object-fit:cover;
  }

  /* RÅDATA BOX */
  .raw-box{
    background:#fff;
    border-radius:8px;
    border:1px solid #ccc;
    padding: 0;
    overflow:hidden;
  }

  .qr-line{
    padding:8px 10px;
    border-bottom:1px solid #222;
    font-size:16px;
    white-space:pre-wrap;
  }

  /* Kategori-overskrifter */
  .section-title{
    font-weight: 900;
    font-size: 16px;
    margin-top: 16px;
    margin-bottom: 6px;
    border-bottom: none;   /* FJERNER RØD LINJE */
  }

  /* UN highlight */
  .un{
    color:#B91C1C;
    font-weight:900;
  }

  /* Vægt farver */
  .weight-green{ color: var(--weight-green); font-weight:900; }
  .weight-yellow{ color: var(--weight-yellow); font-weight:900; }
  .weight-red{ color: var(--weight-red); font-weight:900; }

  /* Buttons */
  .btn{
    width: 100%;
    background:#0A0F1A;
    color:#fff;
    font-size:18px;
    padding:14px;
    border-radius:10px;
    border:0;
    margin-top:12px;
    font-weight:900;
  }
</style>
</head>

<body>

<h1>Info Scan — v6.5</h1>

<!-- SCANNER KORT -->
<div class="card">
  <strong>Scanner</strong>

  <div id="cameraWrap">Kamera er slukket</div>

  <button class="btn" id="scanBtn">NY SCANNING</button>
</div>

<!-- RÅDATA KORT -->
<div class="card">
  <strong>Rådata</strong>

  <div class="raw-box" id="rawBox">
    <div id="rawLines"></div>
  </div>

  <button class="btn" id="copyBtn" disabled>KOPIER</button>
</div>


<script>
// -----------------------------
// HELPERS
// -----------------------------
function escapeHtml(str){
  return String(str).replace(/[&<>"']/g,m=>({
    '&':'&amp;','<':'&lt;','>':'&gt;',
    '"':'&quot;',"'":'&#39;'
  }[m]));
}

function highlightUN(str){
  return str.replace(/\b(UN[0-9]+(?:,[0-9]+)*)\b/g,
    '<span class="un">$1</span>');
}

function extractWeight(line){
  const m=line.match(/Vægt:\s*([\d.,]+)/i);
  if(!m) return null;
  let kg=parseFloat(m[1].replace(",","."));
  return isNaN(kg)?null:kg;
}

function classifyWeight(kg){
  if(kg <= 15) return { cls:"weight-green", extra:"" };
  if(kg <= 30) return { cls:"weight-yellow", extra:" (Pas på når du løfter)" };
  return { cls:"weight-red", extra:" (Brug hjælpe værktøj til løft)" };
}


// -----------------------------
// RAWDATA RENDERING
// -----------------------------
function renderRaw(text){
  const box = document.getElementById("rawLines");
  box.innerHTML = "";

  if(!text.trim()){
    document.getElementById("copyBtn").disabled = true;
    return;
  }

  const lines = text.split(/\r?\n/);

  lines.forEach((line, i)=>{
    let clean = escapeHtml(line);

    // Titellinjer
    if(["Mål:","Lagerplads:"].includes(line.trim())){
      box.insertAdjacentHTML("beforeend",
        `<div class="section-title">${line.replace(":","")}</div>`);
      return;
    }

    // UN farve
    clean = highlightUN(clean);

    // Vægtfarver
    if(line.startsWith("Vægt:")){
      let kg = extractWeight(line);
      if(kg !== null){
        const info = classifyWeight(kg);
        clean = `<span class="${info.cls}">${clean}${info.extra}</span>`;
      }
    }

    box.insertAdjacentHTML("beforeend",
      `<div class="qr-line">${clean}</div>`);
  });

  document.getElementById("copyBtn").disabled = false;
}


// -----------------------------
// CAMERA + SCAN
// -----------------------------
let videoEl=null, stream=null, canvas=null, ctx=null, raf=null;

async function startCamera(){
  if(!videoEl){
    videoEl=document.createElement("video");
    videoEl.setAttribute("playsinline","true");
  }
  if(!canvas){
    canvas=document.createElement("canvas");
    ctx=canvas.getContext("2d");
  }

  try{
    stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:"environment" },
      audio:false
    });
    videoEl.srcObject = stream;
    await videoEl.play();

    const wrap = document.getElementById("cameraWrap");
    wrap.innerHTML="";
    wrap.appendChild(videoEl);

    return true;

  }catch(e){
    return false;
  }
}

function stopCamera(){
  if(raf) cancelAnimationFrame(raf);
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
    stream=null;
  }
  document.getElementById("cameraWrap").innerHTML="Kamera er slukket";
}

// -----------------------------
// QR SCANNING LOOP
// -----------------------------
async function scanLoop(){
  if(videoEl.readyState !== videoEl.HAVE_ENOUGH_DATA){
    raf = requestAnimationFrame(scanLoop);
    return;
  }

  canvas.width = videoEl.videoWidth;
  canvas.height = videoEl.videoHeight;
  ctx.drawImage(videoEl,0,0,canvas.width,canvas.height);

  let img = ctx.getImageData(0,0,canvas.width,canvas.height);

  if(window.jsQR){
    let code = jsQR(img.data, img.width, img.height);
    if(code && code.data){
      stopCamera();
      renderRaw(code.data);
      return;
    }
  }

  raf = requestAnimationFrame(scanLoop);
}


// -----------------------------
// BUTTON HANDLERS
// -----------------------------
document.getElementById("scanBtn").onclick = async ()=>{
  // Ryd rådata
  document.getElementById("rawLines").innerHTML="";
  document.getElementById("copyBtn").disabled=true;

  await startCamera();

  // Load jsQR
  if(!window.jsQR){
    await new Promise(res=>{
      const s=document.createElement("script");
      s.src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js";
      s.onload=res;
      document.head.appendChild(s);
    });
  }

  scanLoop();
};

document.getElementById("copyBtn").onclick = async ()=>{
  await navigator.clipboard.writeText(
    document.getElementById("rawLines").innerText
  );
  alert("Kopieret!");
};

window.addEventListener("beforeunload", stopCamera);
</script>

</body>
</html>
