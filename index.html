<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Info Scan — v6.4</title>

<style>
  :root{
    --bg: #D20014; 
    --text: #111827;
    --un-color: #b91c1c;

    --weight-green: #059669;
    --weight-yellow: #CA8A04;
    --weight-red: #B91C1C;
  }

  body{
    background: var(--bg);
    font-family: Arial, monospace;
    margin: 20px;
    color: var(--text);
  }

  h1{
    color: #fff;
    margin: 0 0 12px 0;
    font-size: 20px;
  }

  .card{
    background: #fff;
    border-radius: 12px;
    padding: 18px;
    margin-top: 15px;
  }

  .section-title{
    font-weight: 700;
    margin-top: 10px;
    margin-bottom: 6px;
    padding-bottom: 3px;
    border-bottom: 2px solid red;
  }

  .line{
    font-family: ui-monospace, monospace;
    padding: 8px 2px;
    border-bottom: 2px solid #000;
    white-space: pre-wrap;
  }

  .weight-green{ color: var(--weight-green); font-weight: bold; }
  .weight-yellow{ color: var(--weight-yellow); font-weight: bold; }
  .weight-red{ color: var(--weight-red); font-weight: bold; }

  .un { color: var(--un-color); font-weight: bold; }

  #hazardIcon{
    position:absolute;
    bottom:8px;
    right:8px;
    width:38px;
    height:38px;
    display:none;
  }

  .btn{
    width: 200px;
    height: 55px;
    border-radius: 10px;
    background: #10131a;
    color: #fff;
    font-size: 18px;
    font-weight: 700;
    border: none;
    margin-top: 15px;
  }

  #cameraWrap video{
    width: 100%;
    height: 100%;
    object-fit: cover;
    transform:none !important;
    -webkit-transform:none !important;
  }

  #cameraWrap{
    background:#f3f4f6;
    border-radius:8px;
    height:260px;
    display:flex;
    align-items:center;
    justify-content:center;
    color:#9ca3af;
    overflow:hidden;
  }

  #rawContainer{
    position: relative;
  }

</style>
</head>

<body>

<h1>Info Scan — v6.4</h1>


<!-- SCANNER CARD -->
<div class="card">
  <div id="cameraWrap">Kamera er slukket</div>
  <button class="btn" id="scanBtn">NY SCANNING</button>
</div>


<!-- RÅDATA CARD -->
<div class="card" id="rawContainer">
  <h2 style="margin-top:0;">Rådata</h2>
  <div id="rawLines"></div>

  <!-- Fare-ikon -->
  <svg id="hazardIcon" viewBox="0 0 400 400">
    <polygon points="200,20 380,200 200,380 20,200"
      fill="white" stroke="#d32f2f" stroke-width="35"/>
    <circle cx="200" cy="270" r="35" fill="black"/>
    <rect x="182" y="90" width="36" height="140" rx="18" fill="black"/>
  </svg>

  <button class="btn" id="copyBtn" disabled>KOPIER</button>
</div>


<script>
/* -----------------------------
     FIXES + SHARED FUNCTIONS
------------------------------*/

const scanBtn  = document.getElementById("scanBtn");
const copyBtn  = document.getElementById("copyBtn");
const cameraWrap = document.getElementById("cameraWrap");
const rawLines = document.getElementById("rawLines");
const hazardIcon = document.getElementById("hazardIcon");

let stream = null, videoEl = null, canvas = null, ctx = null, scanning = false, rafId = null;

const SECTION_TITLES = ["Mål:", "Lagerplads:"];
const GROUPED_FIELDS = {
  "Mål:": ["Længde", "Bredde", "Tykkelse"],
  "Lagerplads:": ["Lager/Område", "Reol", "Hylde", "Plads"]
};

/* Escape HTML */
function escapeHtml(str){
  return str.replace(/[&<>"']/g, m=>({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[m]));
}

/* Highlight UN */
function highlightUN(str){
  return str.replace(/\b(UN\d+(?:[,\.]\d+)*)\b/g,'<span class="un">$1</span>');
}

/* Weight detection */
function extractWeight(line){
  const m = line.match(/Vægt:\s*([\d.,]+)/i);
  if(!m) return null;
  let kg = parseFloat(m[1].replace(",","."));
  return isNaN(kg) ? null : kg;
}

/* Weight class */
function classifyWeight(kg){
  if(kg <= 15) return {cls:"weight-green", extra:""};
  if(kg <= 30) return {cls:"weight-yellow", extra:" (Pas på når du løfter)"};
  return {cls:"weight-red", extra:" (Brug hjælpe værktøj til løft)"};
}

/* -----------------------------
       CAMERA LOGIC
------------------------------*/

async function startCamera(){
  if(!videoEl){
    videoEl = document.createElement("video");
    videoEl.setAttribute("playsinline","true");
  }
  if(!canvas){
    canvas = document.createElement("canvas");
    ctx = canvas.getContext("2d");
  }

  try{
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal:"environment" } },
      audio:false
    });

    videoEl.srcObject = stream;
    await videoEl.play();

    cameraWrap.innerHTML = "";
    cameraWrap.appendChild(videoEl);

    return true;
  }catch(e){
    return false;
  }
}

function stopCamera(){
  if(rafId) cancelAnimationFrame(rafId);

  if(stream){
    stream.getTracks().forEach(t=>t.stop());
    stream = null;
  }

  if(videoEl){
    videoEl.pause();
    videoEl.srcObject = null;
  }

  cameraWrap.textContent = "Kamera er slukket";
}

async function scanLoop(){
  if(!videoEl || videoEl.readyState !== videoEl.HAVE_ENOUGH_DATA){
    rafId = requestAnimationFrame(scanLoop);
    return;
  }

  if(canvas.width !== videoEl.videoWidth){
    canvas.width  = videoEl.videoWidth;
    canvas.height = videoEl.videoHeight;
  }

  ctx.drawImage(videoEl,0,0,canvas.width,canvas.height);
  const img = ctx.getImageData(0,0,canvas.width,canvas.height);

  let code = null;
  if(window.jsQR) code = jsQR(img.data,img.width,img.height);

  if(code && code.data){
    renderRaw(code.data);
    stopCamera();
    scanning = false;
    return;
  }

  rafId = requestAnimationFrame(scanLoop);
}

/* -----------------------------
     RENDER RAW DATA (v6.4)
------------------------------*/

function renderRaw(raw){
  rawLines.innerHTML = "";
  hazardIcon.style.display = "none";
  copyBtn.disabled = false;

  const lines = raw.split(/\r?\n/).map(l=>l.trim()).filter(l=>l);

  let currentGroup = null;

  for(let line of lines){

    /* SECTION TITLES */
    if(SECTION_TITLES.includes(line)){
      currentGroup = line;
      rawLines.insertAdjacentHTML("beforeend",
        `<div class="section-title">${escapeHtml(line)}</div>`
      );
      continue;
    }

    /* GROUPED FIELDS (no divider) */
    if(currentGroup && GROUPED_FIELDS[currentGroup].some(f=>line.startsWith(f))){
      addTextLine(line, false);
      continue;
    }

    /* END OF GROUP → add divider after last grouped element */
    if(currentGroup){
      rawLines.insertAdjacentHTML("beforeend",
        `<div class="line" style="margin-top:-2px;"></div>`
      );
      currentGroup = null;
    }

    /* NORMAL LINE WITH DIVIDER */
    addTextLine(line, true);
  }

  /* Show hazard if UN present */
  if(/\bUN\d+/.test(raw)) hazardIcon.style.display = "block";
}

function addTextLine(line, divider){
  let html = escapeHtml(line);
  html = highlightUN(html);

  if(line.startsWith("Vægt:")){
    const kg = extractWeight(line);
    if(kg !== null){
      const w = classifyWeight(kg);
      html = `<span class="${w.cls}">${html}${escapeHtml(w.extra)}</span>`;
    }
  }

  rawLines.insertAdjacentHTML("beforeend",
    `<div class="${divider ? "line" : ""}">${html}</div>`
  );
}


/* -----------------------------
       SCAN BUTTON LOGIC
------------------------------*/

async function newScan(){
  stopCamera();
  rawLines.innerHTML = "";
  hazardIcon.style.display = "none";
  copyBtn.disabled = true;

  scanning = true;

  await loadJsQr();
  const ok = await startCamera();
  if(!ok) return;

  scanLoop();
}

/* Load jsQR */
function loadJsQr(){
  return new Promise((resolve)=>{
    if(window.jsQR) return resolve();
    const s = document.createElement("script");
    s.src = "https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js";
    s.onload = resolve;
    document.head.appendChild(s);
  });
}

/* Copy */
copyBtn.addEventListener("click", async()=>{
  await navigator.clipboard.writeText(rawLines.innerText);
  copyBtn.textContent = "KOPIERET";
  setTimeout(()=>copyBtn.textContent="KOPIER", 700);
});

/* Main button */
scanBtn.addEventListener("click", newScan);

/* Stop camera on page unload */
window.addEventListener("beforeunload", stopCamera);

</script>
</body>
</html>
