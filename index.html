<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Info Scan — v6.1</title>

<style>
  :root{
    --rw-red: #D20014;
    --text: #111827;
    --muted: #6b7280;
    --un-color: #b91c1c;

    --weight-green:#059669;
    --weight-yellow:#CA8A04;
    --weight-red:#B91C1C;
  }

  body{
    margin:0;
    padding:18px;
    background:var(--rw-red);
    font-family: Arial, monospace;
    color:var(--text);
  }

  .topbar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:16px;
  }

  .title{
    color:white;
    font-size:20px;
    font-weight:700;
  }

  #rwlogo{
    height:34px;
    width:auto;
    display:block;
  }

  .card{
    background:#fff;
    border-radius:12px;
    padding:16px;
    margin-bottom:16px;
  }

  #cameraWrap{
    background:#f3f4f6;
    color:#9ca3af;
    height:260px;
    border-radius:10px;
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
  }

  #cameraWrap video{
    width:100%;
    height:100%;
    object-fit:cover;
    transform:none !important;
    -webkit-transform:none !important;
  }

  .raw-box{
    position:relative;
    border-radius:10px;
    overflow:auto;
  }

  .qr-lines div{
    font-family:ui-monospace, monospace;
    font-size:15px;
    padding:10px;
    border-bottom:2px solid #111;
    white-space:pre-wrap;
  }

  .un{ color:var(--un-color); font-weight:700; }

  .weight-green{ color:var(--weight-green); font-weight:700; }
  .weight-yellow{ color:var(--weight-yellow); font-weight:700; }
  .weight-red{ color:var(--weight-red); font-weight:700; }

  #hazardIcon{
    position:absolute;
    right:10px;
    bottom:10px;
    width:40px;
    height:40px;
    display:none;
    pointer-events:none;
  }

  .btn-row{ display:flex; gap:12px; margin-top:12px; }

  .btn{
    width:160px;
    height:50px;
    border-radius:10px;
    border:none;
    cursor:pointer;
    font-weight:700;
    font-size:16px;
    display:flex;
    align-items:center;
    justify-content:center;
    background:#0d1321;
    color:white;
  }

  .btn.ghost{
    background:white;
    border:1px solid #ddd;
    color:#111;
  }

  .btn:disabled{
    opacity:0.45;
    cursor:not-allowed;
  }
</style>
</head>

<body>

<div class="topbar">
  <div class="title">Info Scan — v6.1</div>
  <img id="rwlogo" src="logo.png" alt="logo" onerror="this.style.display='none'">
</div>

<div class="card">
  <strong>Scanner</strong>

  <div id="cameraWrap">Kamera er slukket</div>

  <div class="btn-row">
    <button class="btn" id="startBtn">START SCANNING</button>
    <button class="btn ghost" id="newBtn" style="display:none;">NY SCANNING</button>
    <div id="scanStatus" style="color:white;margin-left:6px;"></div>
  </div>
</div>

<div class="card">
  <strong>Rådata</strong>

  <div class="raw-box" style="margin-top:10px;">
    <div id="rawLines" class="qr-lines"></div>

    <!-- Fareikon -->
    <svg id="hazardIcon" viewBox="0 0 400 400">
      <polygon points="200,20 380,200 200,380 20,200"
        fill="white" stroke="#d32f2f" stroke-width="35"/>
      <circle cx="200" cy="270" r="35" fill="black"/>
      <rect x="182" y="90" width="36" height="140" rx="18" fill="black"/>
    </svg>
  </div>

  <div class="btn-row">
    <button class="btn ghost" id="copyBtn" disabled>KOPIER</button>
  </div>
</div>

<script>
/* === Scanner Engine v6.1 === */

const startBtn = document.getElementById("startBtn");
const newBtn   = document.getElementById("newBtn");
const copyBtn  = document.getElementById("copyBtn");
const scanStatus = document.getElementById("scanStatus");
const rawLines = document.getElementById("rawLines");
const hazardIcon = document.getElementById("hazardIcon");
const cameraWrap = document.getElementById("cameraWrap");

let videoEl, stream, canvas, ctx, scanning=false, rafId=null;

/* Helpers */
function escapeHtml(str){
  return str.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function normalize(raw){
  return raw.split(/\r?\n/).map(l=>l.trim()).filter(l=>l).join("\n");
}
function highlightUN(t){
  return t.replace(/\b(UN\d+(?:,\d+)*)\b/g,'<span class="un">$1</span>');
}
function extractWeight(line){
  const m=line.match(/Vægt:\s*([\d.,]+)/i);
  if(!m) return null;
  return parseFloat(m[1].replace(",","."));
}
function classifyWeight(kg){
  if(kg<=15) return {cls:"weight-green", extra:""};
  if(kg<=30) return {cls:"weight-yellow", extra:" (Pas på når du løfter)"};
  return {cls:"weight-red", extra:" (Brug hjælpe værktøj til løft)"};
}

/* Ryd rådata */
function clearRaw(){
  rawLines.innerHTML="";
  hazardIcon.style.display="none";
  copyBtn.disabled=true;
}

/* Tegn data */
function setRawData(raw){
  clearRaw();
  const n = normalize(raw);
  if(!n) return;
  const lines = n.split(/\n/);

  if(/\bUN\d+/.test(n)){
    hazardIcon.style.display="block";
  }

  lines.forEach(line=>{
    const div = document.createElement("div");
    let html = escapeHtml(line);
    html = highlightUN(html);

    if(/^Vægt:/i.test(line)){
      const kg = extractWeight(line);
      if(kg!==null){
        const w = classifyWeight(kg);
        div.classList.add(w.cls);
        html += escapeHtml(w.extra);
      }
    }

    div.innerHTML = html;
    rawLines.appendChild(div);
  });

  copyBtn.disabled=false;
}

/* Copy */
copyBtn.onclick = async()=>{
  await navigator.clipboard.writeText(rawLines.innerText);
  const old = copyBtn.innerText;
  copyBtn.innerText = "KOPIERET";
  setTimeout(()=>copyBtn.innerText=old,600);
};

/* Load jsQR */
function loadJsQr(){
  return new Promise((res)=>{
    if(window.jsQR) return res();
    const s=document.createElement("script");
    s.src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js";
    s.onload=res;
    document.head.appendChild(s);
  });
}

/* Kamera */
async function startCamera(){
  if(!videoEl){
    videoEl=document.createElement("video");
    videoEl.setAttribute("playsinline","true");
  }
  if(!canvas){
    canvas=document.createElement("canvas");
    ctx=canvas.getContext("2d");
  }

  try{
    stream=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:{ideal:"environment"}},
      audio:false
    });

    videoEl.srcObject=stream;
    await videoEl.play();
    cameraWrap.innerHTML="";
    cameraWrap.appendChild(videoEl);
    return true;

  }catch(e){
    return false;
  }
}

function stopCamera(){
  if(rafId) cancelAnimationFrame(rafId);
  if(stream) stream.getTracks().forEach(t=>t.stop());
  if(videoEl){
    videoEl.pause();
    videoEl.srcObject=null;
  }
  cameraWrap.innerHTML="Kamera er slukket";
}

/* Scan loop */
function scanLoop(){
  if(!videoEl || videoEl.readyState!==videoEl.HAVE_ENOUGH_DATA){
    rafId=requestAnimationFrame(scanLoop);
    return;
  }

  if(canvas.width!==videoEl.videoWidth){
    canvas.width=videoEl.videoWidth;
    canvas.height=videoEl.videoHeight;
  }

  ctx.drawImage(videoEl,0,0,canvas.width,canvas.height);
  const img=ctx.getImageData(0,0,canvas.width,canvas.height);

  const code = window.jsQR ? jsQR(img.data,img.width,img.height) : null;
  if(code && code.data){
    stopCamera();
    setRawData(code.data);
    scanning=false;
    startBtn.style.display="inline-flex";
    newBtn.style.display="none";
    scanStatus.textContent="";
    return;
  }

  rafId=requestAnimationFrame(scanLoop);
}

/* START SCANNING */
async function startScanning(){
  clearRaw();                      // ←← PROBLEM LØST
  scanning=true;
  startBtn.style.display="none";
  newBtn.style.display="inline-flex";
  scanStatus.textContent="SCANNING…";

  await loadJsQr();
  const ok = await startCamera();
  if(!ok){
    setTimeout(()=>{
      setRawData("Demo\nVægt: 18 kg\nKemi: UN1209");
      scanning=false;
      startBtn.style.display="inline-flex";
      newBtn.style.display="none";
      scanStatus.textContent="";
    },600);
    return;
  }

  scanLoop();
}

/* NY SCANNING */
async function newScanning(){
  clearRaw();                     // ←← OGSÅ RETTET HER
  scanStatus.textContent="SCANNING…";

  stopCamera();

  startBtn.style.display="none";
  newBtn.style.display="inline-flex";

  await new Promise(r=>setTimeout(r,300));
  startScanning();                // ← start scanning på ny
}

/* Event handlers */
startBtn.onclick = startScanning;
newBtn.onclick   = newScanning;

window.addEventListener("beforeunload", stopCamera);
</script>

</body>
</html>
