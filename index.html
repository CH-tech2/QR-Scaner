<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>QR-Scanner v1.5 PRO (ROCKWOOL)</title>
<style>
  :root{
    --bg:#f9fafb;
    --card:#fff;
    --muted:#6b7280;
    --accent:#111827;
    --danger:#b91c1c;
    --btn-height:52px;   /* handske-venlig højde */
    --btn-min-width:140px; /* handske-venlig bredde */
    --btn-gap:12px;
  }
  body{
    margin:0;
    font-family:Arial,monospace;
    background:var(--bg);
    color:var(--accent);
    padding:18px;
  }
  .wrap{max-width:980px;margin:0 auto;display:grid;grid-template-columns:1fr;gap:14px;}
  .card{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.06);}
  header{text-align:center;margin-bottom:6px;}
  header img{width:200px;height:auto;display:block;margin:8px auto;}
  h1{margin:4px 0;font-size:20px;}
  .muted{color:var(--muted);font-size:13px;margin-bottom:8px;text-align:center;}

  /* preview */
  .preview-frame{
    position:relative;
    width:92%;
    max-width:520px;
    height:360px;
    border-radius:12px;
    overflow:hidden;
    background:#000;
    display:flex;
    align-items:center;
    justify-content:center;
    margin:0 auto;
  }
  /* FIX: ikke spejlvendt */
  video#video{
    width:100%;
    height:100%;
    object-fit:cover;
    transform:none !important;
    -webkit-transform:none !important;
  }
  .overlay-rect{
    position:absolute;
    left:50%;top:50%;
    transform:translate(-50%,-50%);
    width:72%;height:72%;
    border:6px solid rgba(255,255,255,0.95);
    border-radius:8px;
    background:rgba(255,255,255,0.02);
  }

  /* controls area */
  .controls{display:flex;gap:var(--btn-gap);justify-content:center;margin-top:14px;flex-wrap:wrap;}
  button{
    padding:0 18px;
    border-radius:12px;
    border:0;
    cursor:pointer;
    font-weight:800;
    font-size:16px;
    min-width:var(--btn-min-width);
    height:var(--btn-height);
    display:inline-flex;
    align-items:center;
    justify-content:center;
    box-shadow:0 2px 6px rgba(2,6,23,0.08);
  }
  .btn-start{background:#111827;color:#fff;border-radius:14px;}
  .btn-ny{background:#111827;color:#fff;border-radius:12px;}
  .btn-copy{background:#eef2ff;color:var(--accent);border-radius:12px;}
  .btn-afslut{background:#fff;color:var(--accent);border-radius:12px;border:1px solid #e6e9ef;}

  /* scanning indicator line (not a button) */
  .status-line{
    display:block;
    text-align:center;
    font-weight:800;
    font-size:16px;
    padding:8px 12px;
    color:#111827;
    border-radius:8px;
    background:#fff;
    min-height:var(--btn-height);
    min-width:var(--btn-min-width);
    display:flex;align-items:center;justify-content:center;
    box-shadow:0 2px 6px rgba(2,6,23,0.04);
  }

  /* result (raw only) */
  #resultCard{margin-top:12px;padding:12px;border-radius:10px;background:#fff;border:1px solid #e6e9ef;min-height:120px;}
  .no-data{color:var(--muted);font-style:italic;}
  .raw-block{background:#fafafa;padding:12px;border-radius:8px;border:1px solid #eee;font-family:monospace;font-size:13px;white-space:pre-wrap;line-height:1.35;color:var(--accent);}

  .raw-block .un{ color: var(--danger); font-weight:700; }

  .note{font-size:13px;color:var(--muted);text-align:center;margin-top:8px;}
  footer{text-align:center;color:var(--muted);font-size:12px;margin-top:10px;}

  .sample{display:flex;gap:12px;align-items:center;justify-content:center;margin-top:12px;}
  img.sampleQR{width:140px;height:140px;border-radius:8px;border:1px solid #e6e9ef;background:#fff;padding:6px;cursor:pointer;}

  /* small screens */
  @media (max-width:600px){
    header img{width:160px;}
    .preview-frame{height:320px;}
    :root{ --btn-min-width:120px; --btn-gap:8px; }
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <header>
      <img src="https://upload.wikimedia.org/wikipedia/commons/d/db/ROCKWOOL_logo.svg" alt="ROCKWOOL logo">
      <h1>QR-Scanner v1.5 PRO (ROCKWOOL)</h1>
      <div class="muted">Tryk <strong>START SCANNING</strong> for at aktivere kameraet og starte scanning.</div>
    </header>

    <div id="scannerArea">
      <div class="preview-frame" id="previewFrame">
        <video id="video" autoplay muted playsinline></video>
        <div class="overlay-rect" aria-hidden="true"></div>
      </div>

      <!-- Controls: initial state shows only start -->
      <div class="controls" id="controlsArea">
        <!-- START SCANNING visible initially -->
        <button id="btnStart" class="btn-start" aria-label="Start scanning">START SCANNING</button>

        <!-- The following are hidden initially; shown after start -->
        <button id="btnNy" class="btn-ny" style="display:none;" aria-label="Ny scanning">NY SCANNING</button>

        <!-- status line (not a clickable button) -->
        <div id="statusLine" class="status-line" style="display:none;">SCANNING…</div>

        <button id="btnCopy" class="btn-copy" style="display:none;" aria-label="Kopier data">KOPIER</button>
        <button id="btnAfslut" class="btn-afslut" style="display:none;" aria-label="Afslut scanning">AFLUT SCANNING</button>
      </div>

      <div id="resultCard" aria-live="polite">
        <div id="noData" class="no-data">Ingen data scannet endnu.</div>
        <div id="rawBlock" class="raw-block" aria-hidden="true" style="display:none;"></div>
      </div>

      <div class="sample">
        <div style="text-align:center;">
          <div class="muted">Prøve-QR (tryk for at bruge som input)</div>
          <img id="sampleQR" class="sampleQR"
            src="https://chart.googleapis.com/chart?chs=200x200&cht=qr&chl=Område%3A%20Symaskine%0AVarenummer%3A%2050021365%0AMateriale%3A%20Tr%C3%A5dv%C3%A6v%20600%20mm%0AAntal%3A%204%20RULL%20p%C3%A5%20PL%0AM%C3%A5l%3A%0A%20%20Bredde%3A%20600%20mm%0AV%C3%A6gt%3A%20332%20kg%0AMeter%20%2F%20m%C2%B2%3A%20480%20m%C2%B2%0AAnden%20info%3A%0ALagerplads%3A%0A%20%20Reol%3A%2002%0A%20%20Hylde%3A%2002%0A%20%20Plads%3A%2003%0AKemi%3A%20UN1209"
            alt="Prøve QR">
        </div>
      </div>

      <div class="note">Når du er klar: tryk <strong>START SCANNING</strong>, giv tilladelse til kameraet, og hold QR-koden i rammen.</div>
    </div>

    <footer>Version 1.5 PRO (ROCKWOOL)</footer>
  </div>
</div>

<!-- jsQR -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
/* Elements */
const video = document.getElementById('video');
const btnStart = document.getElementById('btnStart');
const btnNy = document.getElementById('btnNy');
const btnCopy = document.getElementById('btnCopy');
const btnAfslut = document.getElementById('btnAfslut');
const statusLine = document.getElementById('statusLine');
const rawBlock = document.getElementById('rawBlock');
const noData = document.getElementById('noData');
const sampleQR = document.getElementById('sampleQR');

let canvas = document.createElement('canvas');
let ctx = canvas.getContext('2d');
let stream = null;
let scanning = false;
let rafId = null;

/* Utility helpers */
function escapeHtml(str){
  return (str||'').replace(/[&<>"]/g, function(c){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]; });
}
function highlightUNs(text){
  return text.replace(/(un\s*\d{1,6})/gi, function(m){
    const clean = m.toUpperCase().replace(/\s+/,'');
    return '<span class="un">'+escapeHtml(clean)+'</span>';
  });
}

/* UI state helpers */
function showInitialState(){
  // Only START visible
  btnStart.style.display = '';
  btnNy.style.display = 'none';
  statusLine.style.display = 'none';
  btnCopy.style.display = 'none';
  btnAfslut.style.display = 'none';
  // clear camera & keep data visible or hide? keep data visible (as requested earlier)
  // However per previous flow, on initial app open there is no data shown.
  // We'll keep displayed data as-is; noData will show if no data.
  if(!rawBlock.textContent) {
    rawBlock.style.display = 'none';
    noData.style.display = '';
  } else {
    // data present: show it but keep only START visible
    rawBlock.style.display = '';
    noData.style.display = 'none';
  }
}

function showScanningState(hasData){
  // Show NY SCANNING, status line, KOPIER (if data), AFLUT
  btnStart.style.display = 'none';
  btnNy.style.display = '';
  statusLine.style.display = '';
  btnAfslut.style.display = '';
  // copy only enabled if data exists
  btnCopy.style.display = hasData ? '' : '';
  // Note: btnCopy will be inactive until data; we visually show but disable if no data
  btnCopy.disabled = !hasData;
  btnCopy.style.opacity = hasData ? '1' : '0.6';
}

/* Render raw data (single block) */
function renderRaw(text){
  const safe = escapeHtml(text);
  const highlighted = highlightUNs(safe);
  rawBlock.innerHTML = highlighted;
  rawBlock.style.display = '';
  rawBlock.setAttribute('aria-hidden','false');
  noData.style.display = 'none';
  // enable copy
  btnCopy.disabled = false;
  btnCopy.style.opacity = '1';
}

/* Copy plain text (unformatted) */
async function copyPlain(){
  const txt = rawBlock.innerText || '';
  if(!txt.trim()) return alert('Ingen data at kopiere.');
  try{
    await navigator.clipboard.writeText(txt);
    alert('Data kopieret til udklipsholder.');
  } catch(e){ alert('Kopi mislykkedes: ' + (e && e.message ? e.message : e)); }
}

/* Camera control and scanning */
async function startCamera(){
  try{
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
    video.srcObject = stream;
    scanning = true;
    showScanningState(!!rawBlock.textContent);
    tick();
  } catch(err){
    alert('Fejl ved adgang til kamera: ' + (err && err.message ? err.message : err));
    // revert to initial
    showInitialState();
  }
}

function stopCamera(){
  scanning = false;
  if(rafId) cancelAnimationFrame(rafId);
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
    stream = null;
  }
  video.srcObject = null;
}

/* tick loop using jsQR */
function tick(){
  if(!scanning) return;
  if(video.readyState === video.HAVE_ENOUGH_DATA){
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: 'attemptBoth' });
    if(code && code.data){
      // Render the raw text exactly as in QR (highlight UN codes)
      renderRaw(code.data);
      // Stop camera after successful scan
      stopCamera();
      // After stop, UI should keep the scanning controls visible OR revert?
      // Per spec: AFLUT SCANNING stops but keeps data; NY SCANNING restarts.
      // We'll keep controls visible but indicate scanning stopped by hiding status line.
      statusLine.style.display = 'none';
      // Show controls so user can NY or AFSLUT or KOPIER
      btnNy.style.display = '';
      btnCopy.style.display = '';
      btnCopy.disabled = false;
      btnAfslut.style.display = '';
    }
  }
  rafId = requestAnimationFrame(tick);
}

/* Buttons actions */

// START SCANNING (initial big button)
btnStart.addEventListener('click', async ()=>{
  // clear previous UI? keep data as requested; but ensure we start camera
  // hide rawBlock until new result appears
  // per earlier: "Start scanning only visible when app starts ... after pressing start scanning"
  // => when starting, keep rawBlock hidden for clarity
  rawBlock.style.display = 'none';
  noData.style.display = '';
  showScanningState(false);
  await startCamera();
});

// NY SCANNING: clear previous data and restart scanning
btnNy.addEventListener('click', ()=>{
  // clear displayed data
  rawBlock.textContent = '';
  rawBlock.style.display = 'none';
  noData.style.display = '';
  btnCopy.disabled = true;
  btnCopy.style.opacity = '0.6';
  // show scanning UI and restart camera
  showScanningState(false);
  // ensure camera restarts
  startCamera();
});

// KOPIER
btnCopy.addEventListener('click', ()=>{
  copyPlain();
});

// AFLUT SCANNING (stop and return to initial state showing START SCANNING)
// It should stop camera but keep the data shown, and return UI to initial single-button state
btnAfslut.addEventListener('click', ()=>{
  stopCamera();
  // keep data visible (if any)
  if(rawBlock.textContent) {
    rawBlock.style.display = '';
    noData.style.display = 'none';
  } else {
    rawBlock.style.display = 'none';
    noData.style.display = '';
  }
  // show only start button
  showInitialState();
});

/* Sample QR click to test without camera */
sampleQR.addEventListener('click', async (e)=>{
  const img = e.target;
  const tmp = document.createElement('canvas');
  const tctx = tmp.getContext('2d');
  await new Promise(res => { if(img.complete) res(); else img.onload = res; });
  tmp.width = img.naturalWidth; tmp.height = img.naturalHeight;
  tctx.drawImage(img, 0, 0);
  const data = tctx.getImageData(0,0,tmp.width,tmp.height);
  const code = jsQR(data.data, data.width, data.height, { inversionAttempts: 'attemptBoth' });
  if(code && code.data){
    renderRaw(code.data);
    // when testing via sample, show controls as if scanned (no camera)
    statusLine.style.display = 'none';
    btnStart.style.display = 'none';
    btnNy.style.display = '';
    btnCopy.style.display = '';
    btnCopy.disabled = false;
    btnAfslut.style.display = '';
    noData.style.display = 'none';
  } else {
    alert('Kunne ikke læse prøve-QR.');
  }
});

/* Stop camera when navigating away */
window.addEventListener('beforeunload', stopCamera);

/* Initialize UI */
showInitialState();
</script>
</body>
</html>
