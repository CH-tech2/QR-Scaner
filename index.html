<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>QR Scanner v2.3</title>

<!-- jsQR (decoder) -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<style>
  :root{
    --bg: #f9fafb;
    --text: #111827;
    --muted: #6b7280;
    --un-color: #b91c1c;
    --card-bg: #ffffff;
    --card-border: #e6e8eb;
  }

  /* Page layout */
  body{
    background: var(--bg);
    color: var(--text);
    font-family: Arial, monospace;
    margin: 20px;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  h1 { font-size:18px; margin:0 0 12px 0; }
  .container{ display:grid; grid-template-columns:1fr 1fr; gap:20px; align-items:start; }
  .card{ background:var(--card-bg); border:1px solid var(--card-border); border-radius:10px; padding:16px; }

  /* Camera preview box */
  #cameraWrap{
    background:#f3f4f6;
    border-radius:8px;
    height:260px;
    display:flex;
    align-items:center;
    justify-content:center;
    color:#9ca3af;
    overflow:hidden;
    position:relative;
  }
  #cameraWrap video{ width:100%; height:100%; object-fit:cover; -webkit-transform:none !important; transform:none !important; }

  /* Raw-lines style (like your screenshot) */
  .raw-box{ background:#fff; border-radius:8px; padding:0; border:1px solid #e5e7eb; overflow:auto; }
  .qr-lines div{
    padding:8px 10px;
    border-bottom:2px solid #111; /* bold underline like image */
    font-family: ui-monospace, "SFMono-Regular", Menlo, Monaco, "Roboto Mono", "Courier New", monospace;
    font-size:15px;
    line-height:1.25;
    white-space:pre-wrap;
  }
  .qr-lines .un{ color: var(--un-color); font-weight:700; }

  /* Buttons (v1.5 PRO) */
  .btn-row{ display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; align-items:center; }
  .btn{
    width:140px;
    height:48px;
    border-radius:8px;
    border:0;
    cursor:pointer;
    font-weight:700;
    font-size:16px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    background:#111827;
    color:#fff;
  }
  .btn.ghost{ background:#fff; color:#111827; border:1px solid #d1d5db; }
  .btn:disabled{ opacity:0.45; cursor:not-allowed; }

  /* Status text */
  .status{ color:var(--muted); font-size:14px; margin-left:6px; }

  /* Responsiveness */
  @media (max-width:900px){
    .container{ grid-template-columns:1fr; }
  }
</style>
</head>
<body>
<h1>QR Scanner — v2.3</h1>

<div class="container">
  <!-- Scanner card -->
  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;">
      <strong>Scanner</strong>
      <!-- Rockwool logo placeholder (replace src med din fil hvis du har) -->
      <img src="" alt="" style="height:26px;opacity:0.9;display:none;">
    </div>

    <div id="cameraWrap" aria-label="Kameravisning">
      Kamera preview
    </div>

    <div class="btn-row" style="margin-top:12px;">
      <button class="btn" id="startBtn">START SCANNING</button>
      <button class="btn ghost" id="newBtn" disabled>NY SCANNING</button>
      <div class="status" id="scanStatus"></div>
    </div>
  </div>

  <!-- Raw data card -->
  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;">
      <strong>Rådata</strong>
      <div style="font-size:12px;color:var(--muted);">Monospace — kun rå tekst</div>
    </div>

    <div class="raw-box" style="margin-top:10px;">
      <div id="rawLines" class="qr-lines" aria-live="polite"></div>
    </div>

    <div class="btn-row">
      <button class="btn ghost" id="copyBtn" disabled>KOPIER</button>
      <button class="btn" id="endBtn">AFLUT SCANNING</button>
    </div>
  </div>
</div>

<!-- Table / ordered fields (still useful) -->
<div class="card" style="margin-top:18px;">
  <strong>Tabelvisning (fast rækkefølge)</strong>
  <div id="qrTable" class="qr-lines" style="margin-top:10px;"></div>
</div>

<script>
/* QR Scanner v2.3
   - Uses getUserMedia (environment)
   - Decodes with jsQR
   - Shows raw lines exactly like screenshot (one line per field)
   - UNxxxx highlighted
*/

/* Version */
const VERSION = 'v2.3';

/* Field order (for table rendering) */
const FIELD_ORDER = [
  "Område","Varenummer","Materiale","Antal","Mål","L","B","T","V",
  "Meter","Areal m²","Anden info","Kemi","Reol","Hylde","Plads"
];

/* Elements */
const startBtn = document.getElementById('startBtn');
const newBtn   = document.getElementById('newBtn');
const copyBtn  = document.getElementById('copyBtn');
const endBtn   = document.getElementById('endBtn');
const scanStatus = document.getElementById('scanStatus');
const cameraWrap = document.getElementById('cameraWrap');
const rawLines = document.getElementById('rawLines');
const qrTable = document.getElementById('qrTable');

let stream = null;
let scanning = false;
let scanAnimationId = null;
let videoEl = null;
let canvas = null;
let ctx = null;

/* Utilities */
function escapeHtml(str){
  return str.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function normalizeRawText(raw){
  return raw.split(/\r?\n/).map(l=>l.trim()).filter(l=>l!=='').join('\n');
}
function highlightUN(text){
  return text.replace(/\b(UN\d{1,6})\b/g, '<span class="un">$1</span>');
}

/* Render raw lines (exact visual like screenshot) */
function setRawData(raw){
  rawLines.innerHTML = '';
  if(!raw){ copyBtn.disabled = true; return; }
  const normalized = normalizeRawText(raw);
  if(!normalized){ copyBtn.disabled = true; return; }

  const lines = normalized.split(/\r?\n/);
  lines.forEach(line => {
    const div = document.createElement('div');
    div.innerHTML = highlightUN(escapeHtml(line));
    rawLines.appendChild(div);
  });

  copyBtn.disabled = false;
  renderTable(normalized);
}

/* Render ordered "table" as stacked lines */
function renderTable(raw){
  qrTable.innerHTML = '';
  if(!raw) return;
  const map = {};
  raw.split(/\r?\n/).forEach(line=>{
    const p = line.split(':');
    if(p.length < 2) return;
    const key = p[0].trim();
    const val = p.slice(1).join(':').trim();
    map[key] = val;
  });

  FIELD_ORDER.forEach(k=>{
    if(map[k]){
      const d = document.createElement('div');
      d.innerHTML = highlightUN(escapeHtml(k + ': ' + map[k]));
      qrTable.appendChild(d);
    }
  });
}

/* Copy raw text (plain) */
async function copyRaw(){
  try{
    const text = rawLines.innerText || '';
    await navigator.clipboard.writeText(text);
    const prev = copyBtn.textContent;
    copyBtn.textContent = 'KOPIERET';
    setTimeout(()=> copyBtn.textContent = prev, 1000);
  }catch(e){
    alert('Kunne ikke kopiere — brug Ctrl/Cmd+C.');
  }
}

/* Camera helpers */
async function startCamera(){
  // create video & canvas if not exist
  if(!videoEl){
    videoEl = document.createElement('video');
    videoEl.setAttribute('playsinline', 'true');
    videoEl.style.width = '100%';
    videoEl.style.height = '100%';
  }

  if(!canvas){
    canvas = document.createElement('canvas');
    ctx = canvas.getContext('2d');
  }

  try{
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: "environment" } }, audio: false });
    videoEl.srcObject = stream;
    await videoEl.play();

    // insert video into cameraWrap
    cameraWrap.innerHTML = '';
    cameraWrap.appendChild(videoEl);

    // ensure canvas size matches video
    canvas.width = videoEl.videoWidth || 640;
    canvas.height = videoEl.videoHeight || 480;
    return true;
  }catch(e){
    console.warn('camera start failed', e);
    return false;
  }
}

/* Stop camera */
function stopCamera(){
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
    stream = null;
  }
  if(videoEl){
    try{ videoEl.pause(); }catch(e){}
  }
  if(cameraWrap){
    cameraWrap.innerHTML = 'Kamera er slukket';
  }
}

/* Scanning loop using jsQR */
function scanFrame(){
  if(!videoEl || videoEl.readyState !== videoEl.HAVE_ENOUGH_DATA){
    scanAnimationId = requestAnimationFrame(scanFrame);
    return;
  }

  // match canvas size to current video frame
  if(canvas.width !== videoEl.videoWidth || canvas.height !== videoEl.videoHeight){
    canvas.width = videoEl.videoWidth;
    canvas.height = videoEl.videoHeight;
  }

  ctx.drawImage(videoEl, 0, 0, canvas.width, canvas.height);
  const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
  const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });

  if(code && code.data){
    // Found QR — set and stop camera per spec (camera slukkes ved afslut scanning)
    setRawData(code.data);
    scanning = false;
    stopCamera();
    // After scanning, per spec only START should be visible. We'll update buttons below.
    updateButtonsAfterScan();
    return; // do not continue scanning
  }

  // continue loop
  scanAnimationId = requestAnimationFrame(scanFrame);
}

/* Button logic per v1.5 PRO */
function updateButtonsOnStart(){
  startBtn.disabled = true;
  newBtn.disabled = true;
  copyBtn.disabled = true;
  scanStatus.textContent = 'SCANNING…';
  // ensure end button is enabled visually (always visible)
}

function updateButtonsDuringScanning(){
  // while scanning (camera active, waiting for QR) show NY SCANNING + KOPIER (disabled until data)
  startBtn.disabled = true;
  newBtn.disabled = false;
  copyBtn.disabled = true;
  scanStatus.textContent = 'SCANNING…';
}

function updateButtonsAfterScan(){
  // camera is off and data shown: per spec only START SCANNING should be visible.
  // we'll disable newBtn and keep copy enabled.
  startBtn.disabled = false;
  newBtn.disabled = true;
  copyBtn.disabled = false;
  scanStatus.textContent = '';
}

/* Public actions */
async function startScanning(){
  if(scanning) return;
  scanning = true;
  updateButtonsOnStart();

  const ok = await startCamera();
  if(!ok){
    // fallback: simulate sample data if camera can't be used
    const demo = 'Område: KONF\nVarenummer: 50023166\nMateriale: Tape\nAntal: 18';
    setTimeout(()=> {
      setRawData(demo);
      scanning = false;
      updateButtonsAfterScan();
    }, 800);
    return;
  }

  // camera started -> start scan loop
  updateButtonsDuringScanning();
  scanFrame();
}

function newScanning(){
  // Under scanning: reset raw display and keep camera on
  rawLines.innerHTML = '';
  qrTable.innerHTML = '';
  copyBtn.disabled = true;
  scanStatus.textContent = 'SCANNING…';
  // If camera not active, start it again
  if(!stream) startScanning();
  else {
    // already scanning — keep going
    // (we keep scanning loop running)
  }
}

function endScanning(){
  // stop camera, keep raw data visible, set buttons to initial state
  stopCamera();
  scanning = false;
  startBtn.disabled = false;
  newBtn.disabled = true;
  scanStatus.textContent = '';
}

/* Copy handler */
copyBtn.addEventListener('click', copyRaw);
startBtn.addEventListener('click', startScanning);
newBtn.addEventListener('click', newScanning);
endBtn.addEventListener('click', endScanning);

/* Stop camera on unload */
window.addEventListener('beforeunload', () => {
  stopCamera();
});

/* Expose for debugging */
window.__QR_SCANNER_VERSION = VERSION;
</script>
</body>
</html>
