<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Info Scan — v6.6</title>
<style>
  :root{
    --rw-red: #D20014;
    --text: #111827;
    --muted:#6b7280;
    --un: #b91c1c;
    --green: #059669;
    --yellow: #CA8A04;
    --red: #B91C1C;
  }

  /* Page */
  body{
    margin:0;
    padding:16px;
    background:var(--rw-red);
    font-family: Arial, monospace;
    color:var(--text);
  }

  /* Top bar with logo on left */
  .topbar{
    display:flex;
    align-items:center;
    gap:12px;
    margin-bottom:12px;
  }
  .rw-logo{
    height:70px;        /* ~A-size as requested */
    width:auto;
    display:block;
  }
  .title{
    color:#fff;
    font-size:22px;
    font-weight:900;
  }

  /* Cards */
  .container{ display:grid; grid-template-columns:1fr; gap:14px; }
  .card{ background:#fff; border-radius:12px; padding:14px; }

  /* Camera */
  #cameraWrap{
    background:#f3f4f6;
    border-radius:10px;
    height:260px;
    display:flex;
    align-items:center;
    justify-content:center;
    color:#9ca3af;
    overflow:hidden;
  }
  #cameraWrap video{ width:100%; height:100%; object-fit:cover; transform:none !important; -webkit-transform:none !important; }

  /* Raw data */
  .raw-box{ position:relative; border-radius:8px; overflow:auto; background:#fff; }
  #rawLines{ padding:6px 4px; }
  .data-line{
    font-family: ui-monospace, monospace;
    font-size:15px;
    padding:8px 10px;
    border-bottom:2px solid #000;   /* svart skillelinje mellem datafelter */
    white-space:pre-wrap;
  }

  /* Section titles (bold only) */
  .section-title{
    font-weight:900;
    font-size:16px;
    margin:8px 0 6px 0;
    border-bottom:none; /* REMOVE red/any underline */
    padding:0;
  }

  /* UN highlight */
  .un{ color:var(--un); font-weight:900; }

  /* Weight classes */
  .weight-green{ color:var(--green); font-weight:900; }
  .weight-yellow{ color:var(--yellow); font-weight:900; }
  .weight-red{ color:var(--red); font-weight:900; }

  /* Hazard icon */
  #hazardIcon{ position:absolute; right:10px; bottom:10px; width:42px; height:42px; display:none; pointer-events:none; }

  /* Buttons */
  .btn{
    width:100%;
    height:56px;
    border-radius:10px;
    border:0;
    background:#0d1321;
    color:#fff;
    font-weight:900;
    font-size:18px;
    cursor:pointer;
    margin-top:12px;
  }
  .btn.ghost{
    background:#fff; color:#111; border:1px solid #d1d5db;
  }

  @media(max-width:900px){
    .rw-logo{ height:56px; }
    body{ padding:12px; }
  }
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
  <img id="rwlogo" class="rw-logo" src="logo.png" alt="ROCKWOOL logo" onerror="this.style.display='none'">
  <div class="title">Info Scan — v6.6</div>
</div>

<div class="container">

  <!-- SCANNER CARD -->
  <div class="card">
    <strong>Scanner</strong>
    <div id="cameraWrap">Kamera er slukket</div>

    <!-- Only one button, always visible -->
    <button id="scanBtn" class="btn">NY SCANNING</button>
  </div>

  <!-- RAW DATA CARD -->
  <div class="card">
    <strong>Rådata</strong>

    <div class="raw-box" style="margin-top:10px;">
      <div id="rawLines"></div>

      <!-- Hazard icon (shows when UN present) -->
      <svg id="hazardIcon" viewBox="0 0 400 400">
        <polygon points="200,20 380,200 200,380 20,200" fill="white" stroke="#d32f2f" stroke-width="35"/>
        <circle cx="200" cy="270" r="35" fill="black"/>
        <rect x="182" y="90" width="36" height="140" rx="18" fill="black"/>
      </svg>
    </div>

    <button id="copyBtn" class="btn ghost" disabled style="margin-top:12px;">KOPIER</button>
  </div>
</div>

<script>
/* Info Scan v6.6 (Logo Edition)
   - Uses file-based logo.png
   - One button NY SCANNING that clears and starts scanning
   - Grouping for Mål and Lagerplads
   - Category titles bold only
   - Weight coloring and texts restored
   - UN highlight and hazard icon
   - Android permission trick + fallback camera constraints
*/

const scanBtn = document.getElementById("scanBtn");
const copyBtn = document.getElementById("copyBtn");
const rawLines = document.getElementById("rawLines");
const cameraWrap = document.getElementById("cameraWrap");
const hazardIcon = document.getElementById("hazardIcon");

let videoEl = null, canvas = null, ctx = null, stream = null, rafId = null;

// GROUPS config
const SECTION_TITLES = ["Mål:", "Lagerplads:"];
const GROUPED_FIELDS = {
  "Mål:": ["Længde","Bredde","Tykkelse"],
  "Lagerplads:": ["Lager/Område","Reol","Hylde","Plads"]
};

/* Helpers */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function highlightUN(s){ return s.replace(/\b(UN\d+(?:,\d+)*)\b/g,'<span class="un">$1</span>'); }

function extractWeight(line){
  const m = line.match(/Vægt:\s*([\d.,]+)/i);
  if(!m) return null;
  const kg = parseFloat(m[1].replace(",","."));
  return isNaN(kg) ? null : kg;
}
function classifyWeight(kg){
  if(kg <= 15) return {cls:"weight-green", extra:""};
  if(kg <= 30) return {cls:"weight-yellow", extra:" (Pas på når du løfter)"};
  return {cls:"weight-red", extra:" (Brug hjælpe værktøj til løft)"};
}

/* Clear raw area */
function clearRaw(){
  rawLines.innerHTML = "";
  hazardIcon.style.display = "none";
  copyBtn.disabled = true;
}

/* Render raw with grouping rules */
function renderRaw(raw){
  clearRaw();
  if(!raw || !raw.trim()) return;

  const lines = raw.split(/\r?\n/).map(l=>l.trim()).filter(l=>l!=="");
  let currentGroup = null;

  for(const line of lines){
    // Section title
    if(SECTION_TITLES.includes(line)){
      // show title as bold (without colon)
      const titleText = line.replace(/:$/,"");
      rawLines.insertAdjacentHTML("beforeend", `<div class="section-title">${escapeHtml(titleText)}</div>`);
      currentGroup = line;
      continue;
    }

    // inside group (no divider)
    if(currentGroup && GROUPED_FIELDS[currentGroup].some(f=>line.startsWith(f))){
      addDataLine(line, false);
      continue;
    }

    // leaving group (no extra special divider required)
    if(currentGroup){
      currentGroup = null;
    }

    // normal line with divider
    addDataLine(line, true);
  }

  // hazard if UN present
  if(/\bUN\d+/.test(raw)) hazardIcon.style.display = "block";

  copyBtn.disabled = false;
}

/* add data line; divider controls presence of black bottom border (via .data-line) */
function addDataLine(line, divider){
  let html = escapeHtml(line);
  html = highlightUN(html);

  if(/^Vægt:/i.test(line)){
    const kg = extractWeight(line);
    if(kg !== null){
      const info = classifyWeight(kg);
      html = `<span class="${info.cls}">${html}${escapeHtml(info.extra)}</span>`;
    }
  }

  const cls = divider ? "data-line" : "";
  rawLines.insertAdjacentHTML("beforeend", `<div class="${cls}">${html}</div>`);
}

/* Copy */
copyBtn.addEventListener("click", async()=>{
  try{
    await navigator.clipboard.writeText(rawLines.innerText);
    const prev = copyBtn.innerText;
    copyBtn.innerText = "KOPIERET";
    setTimeout(()=>copyBtn.innerText = prev,800);
  }catch(e){}
});

/* jsQR loader */
function loadJsQr(){
  return new Promise(res=>{
    if(window.jsQR) return res();
    const s=document.createElement("script");
    s.src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js";
    s.onload = res;
    document.head.appendChild(s);
  });
}

/* Ask permission trick to help Android */
async function askForPermission(){
  if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) return false;
  try{
    const tmp = await navigator.mediaDevices.getUserMedia({ video:true });
    tmp.getTracks().forEach(t=>t.stop());
    return true;
  }catch(e){
    return false;
  }
}

/* start camera with progressive fallbacks */
async function startCamera(){
  if(!videoEl){
    videoEl = document.createElement("video");
    videoEl.setAttribute("playsinline","true");
  }
  if(!canvas){
    canvas = document.createElement("canvas");
    ctx = canvas.getContext("2d");
  }

  const attempts = [
    { video: { facingMode: { exact: "environment" } } },
    { video: { facingMode: { ideal: "environment" } } },
    { video: true }
  ];

  for(const c of attempts){
    try{
      stream = await navigator.mediaDevices.getUserMedia(Object.assign({audio:false}, c));
      videoEl.srcObject = stream;
      await videoEl.play();
      cameraWrap.innerHTML = ""; cameraWrap.appendChild(videoEl);
      return true;
    }catch(e){
      // try next
    }
  }
  return false;
}

/* stop camera */
function stopCamera(){
  if(rafId) cancelAnimationFrame(rafId);
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
    stream = null;
  }
  if(videoEl){
    try{ videoEl.pause(); }catch(e){}
    videoEl.srcObject = null;
  }
  cameraWrap.innerHTML = "Kamera er slukket";
}

/* scan loop */
async function scanLoop(){
  if(!videoEl || videoEl.readyState !== videoEl.HAVE_ENOUGH_DATA){
    rafId = requestAnimationFrame(scanLoop);
    return;
  }

  if(canvas.width !== videoEl.videoWidth){
    canvas.width = videoEl.videoWidth; canvas.height = videoEl.videoHeight;
  }

  ctx.drawImage(videoEl,0,0,canvas.width,canvas.height);
  const img = ctx.getImageData(0,0,canvas.width,canvas.height);
  let code = window.jsQR ? jsQR(img.data,img.width,img.height) : null;

  if(code && code.data){
    stopCamera();
    renderRaw(code.data);
    return;
  }

  rafId = requestAnimationFrame(scanLoop);
}

/* Main single button handler: always visible */
scanBtn.addEventListener("click", async ()=>{
  // clear UI immediately
  clearRaw();

  // stop any running camera
  stopCamera();

  // ask permission to improve Android reliability
  const perm = await askForPermission();
  if(!perm){
    // permission not granted — show message in cameraWrap and bail
    cameraWrap.innerHTML = "Kamera-adgang nægtet eller ikke understøttet";
    return;
  }

  await loadJsQr();

  const ok = await startCamera();
  if(!ok){
    cameraWrap.innerHTML = "Kan ikke få adgang til kamera";
    return;
  }

  scanLoop();
});

/* ensure stop camera on unload */
window.addEventListener("beforeunload", stopCamera);
</script>
</body>
</html>
