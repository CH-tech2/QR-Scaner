<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Info Scan — v8.1</title>
<style>
  :root{
    --rw-red:#D20014;
    --text:#111827;
    --black:#000;
    --un:#b91c1c;
    --green:#059669;
    --yellow:#CA8A04;
    --red:#B91C1C;
  }

  body{
    margin:0;
    padding:12px;
    font-family: Arial, ui-monospace, monospace;
    background:var(--rw-red);
    color:var(--text);
  }

  .topbar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
    margin-bottom:10px;
  }
  .topTitle{
    color:#fff;
    font-weight:900;
    font-size:20px;
  }
  .logo{
    height:70px;
    width:auto;
    display:block;
  }

  .card{
    background:#fff;
    border-radius:12px;
    padding:14px;
    margin-bottom:14px;
  }

  #cameraWrap{
    height:260px;
    border-radius:10px;
    background:#f3f4f6;
    display:flex;
    align-items:center;
    justify-content:center;
    color:#9ca3af;
    overflow:hidden;
  }

  /* Genskab iPhone kompatibilitet */
  #cameraWrap video{
    width:100%;
    height:100%;
    object-fit:cover;   /* VIGTIGT: iPhone-krav */
    transform:none !important;
    -webkit-transform:none !important;
  }

  .btn{
    width:100%;
    height:56px;
    margin-top:14px;
    border-radius:10px;
    border:0;
    background:#0f172a;
    color:#fff;
    font-weight:900;
    font-size:18px;
    cursor:pointer;
  }

  .box{
    border:2px solid var(--black);
    border-radius:6px;
    padding:10px 12px;
    margin-bottom:12px;
    background:white;
  }

  .catTitle{
    font-size:17px;
    font-weight:900;
    margin-bottom:8px;
  }

  .boxValue{
    font-family: ui-monospace, monospace;
    font-size:16px;
    white-space:pre-wrap;
  }

  .w-green{ color:var(--green); font-weight:900; }
  .w-yellow{ color:var(--yellow); font-weight:900; }
  .w-red{ color:var(--red); font-weight:900; }

  .kemiRow{
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .hazard{
    width:34px;
    height:34px;
  }

  #copyBtn{
    width:100%;
    height:50px;
    margin-top:12px;
    border-radius:10px;
    border:2px solid #ddd;
    background:white;
    font-weight:900;
    font-size:16px;
    cursor:pointer;
  }

  @media (max-width:700px){
    .logo{ height:56px; }
    .topTitle{ font-size:18px; }
  }
</style>
</head>
<body>

<div class="topbar">
  <div class="topTitle">Info Scan — v8.1</div>
  <img class="logo" src="logo.png" alt="ROCKWOOL logo" onerror="this.style.display='none'"/>
</div>

<div class="card">
  <div style="font-weight:700;margin-bottom:8px;">Scanner</div>
  <div id="cameraWrap">Kamera er slukket</div>
  <button id="scanBtn" class="btn">NY SCANNING</button>
</div>

<div class="card" style="position:relative;">
  <div style="font-weight:700;margin-bottom:10px;font-size:18px;">Rådata</div>
  <div id="output"></div>
  <button id="copyBtn" disabled>KOPIER</button>
</div>

<script>
/* Elementer */
const scanBtn = document.getElementById('scanBtn');
const output  = document.getElementById('output');
const copyBtn = document.getElementById('copyBtn');
const cameraWrap = document.getElementById('cameraWrap');

let videoEl = null;
let canvas = null;
let ctx = null;
let stream = null;
let raf = null;

/* Utils */
function esc(s){ return String(s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }
function clearOutput(){ output.innerHTML=''; copyBtn.disabled=true; }

/* ----- PARSER (uændret) ----- */
/* ... parserkoden identisk med din v7.7 ... */

/* ---------- CAMERA (FIXED FOR IPHONE + ANDROID) ---------- */
async function startCamera(){
  clearOutput();

  if(!videoEl){
    videoEl = document.createElement('video');
    videoEl.setAttribute('playsinline','true');
  }
  if(!canvas){
    canvas = document.createElement('canvas');
    ctx = canvas.getContext('2d',{willReadFrequently:true});
  }

  /* Fuld kompatibilitet – ingen zoom, fleksibel opløsning */
  const constraints = {
    video: {
      facingMode: { ideal:"environment" },
      width:  { ideal:1280, max:1920 },
      height: { ideal:720,  max:1080 }
    },
    audio:false
  };

  try{
    stream = await navigator.mediaDevices.getUserMedia(constraints);

    /* Fokus ja — ZOOM NEJ (vigtigt for Android) */
    try{
      const track = stream.getVideoTracks()[0];
      const caps = track.getCapabilities?.() || {};

      const adv = [];
      if(caps.focusMode && caps.focusMode.includes("continuous"))
        adv.push({ focusMode:"continuous" });

      if(adv.length) track.applyConstraints({advanced:adv});
    }catch(e){}

    videoEl.srcObject = stream;
    await videoEl.play();

    cameraWrap.innerHTML = "";
    cameraWrap.appendChild(videoEl);

    return true;

  }catch(err){
    console.warn("Camera error:",err);
    return false;
  }
}

function stopCamera(){
  if(raf) cancelAnimationFrame(raf);
  raf=null;

  if(stream){
    stream.getTracks().forEach(t=>t.stop());
    stream=null;
  }
  if(videoEl) videoEl.srcObject=null;

  cameraWrap.innerHTML="Kamera er slukket";
}

/* ---------- SCAN LOOP ---------- */
async function scanLoop(){
  if(!videoEl || videoEl.readyState !== videoEl.HAVE_ENOUGH_DATA){
    raf=requestAnimationFrame(scanLoop);
    return;
  }

  if(canvas.width !== videoEl.videoWidth){
    canvas.width = videoEl.videoWidth;
    canvas.height = videoEl.videoHeight;
  }

  ctx.drawImage(videoEl,0,0,canvas.width,canvas.height);

  let img;
  try{ img = ctx.getImageData(0,0,canvas.width,canvas.height); }
  catch(e){
    raf=requestAnimationFrame(scanLoop);
    return;
  }

  let code=null;
  if(window.jsQR){
    code = jsQR(img.data,img.width,img.height,{ inversionAttempts:'attemptBoth' });
  }

  if(code && code.data){
    stopCamera();
    const parsed = parseRaw(code.data);
    renderData(parsed);
    return;
  }

  raf=requestAnimationFrame(scanLoop);
}

/* ---------- LOAD jsQR ---------- */
function loadJsQR(){
  return new Promise(res=>{
    if(window.jsQR) return res();
    const s=document.createElement("script");
    s.src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js";
    s.onload=res;
    s.onerror=res;
    document.head.appendChild(s);
  });
}

/* ---------- BUTTON ---------- */
scanBtn.addEventListener("click", async ()=>{
  clearOutput();
  cameraWrap.innerHTML="Starter kamera…";

  await loadJsQR();
  const ok = await startCamera();

  if(ok) scanLoop();
});

/* COPY */
copyBtn.addEventListener('click',async()=>{
  try{
    await navigator.clipboard.writeText(output.innerText||"");
    copyBtn.textContent="KOPIERET";
    setTimeout(()=>copyBtn.textContent="KOPIER",700);
  }catch(e){}
});

window.addEventListener("beforeunload",stopCamera);
</script>
</body>
</html>
