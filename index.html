<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Info Scan — v8.5</title>
<style>
  :root{
    --rw-red:#D20014;
    --text:#111827;
    --black:#000;
    --un:#b91c1c;
    --green:#059669;
    --yellow:#CA8A04;
    --red:#B91C1C;
  }

  body{
    margin:0;
    padding:12px;
    font-family: Arial, ui-monospace, monospace;
    background:var(--rw-red);
    color:var(--text);
  }

  .topbar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
    margin-bottom:10px;
  }
  .topTitle{
    color:#fff;
    font-weight:900;
    font-size:20px;
  }
  .logo{
    height:70px;
    width:auto;
    display:block;
  }

  .card{
    background:#fff;
    border-radius:12px;
    padding:14px;
    margin-bottom:14px;
  }

  #cameraWrap{
    height:260px;
    border-radius:10px;
    background:#f3f4f6;
    display:flex;
    align-items:center;
    justify-content:center;
    color:#9ca3af;
    overflow:hidden;
  }

  #cameraWrap video{
    width:100%;
    height:100%;
    object-fit:cover;
  }
  
  #qr-reader{
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .btn{
    width:100%;
    height:56px;
    margin-top:14px;
    border-radius:10px;
    border:0;
    background:#0f172a;
    color:#fff;
    font-weight:900;
    font-size:18px;
    cursor:pointer;
  }

  .box{
    border:2px solid var(--black);
    border-radius:6px;
    padding:10px 12px;
    margin-bottom:12px;
    background:white;
  }

  .catTitle{
    font-size:17px;
    font-weight:900;
    margin-bottom:8px;
  }

  .boxValue{
    font-family: ui-monospace, monospace;
    font-size:16px;
    white-space:pre-wrap;
  }

  .w-green{ color:var(--green); font-weight:900; }
  .w-yellow{ color:var(--yellow); font-weight:900; }
  .w-red{ color:var(--red); font-weight:900; }

  .kemiRow{
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .hazard{
    width:34px;
    height:34px;
  }

  #copyBtn{
    width:100%;
    height:50px;
    margin-top:12px;
    border-radius:10px;
    border:2px solid #ddd;
    background:white;
    font-weight:900;
    font-size:16px;
    cursor:pointer;
  }

  @media (max-width:700px){
    .logo{ height:56px; }
    .topTitle{ font-size:18px; }
  }
</style>
<script src="unpkg.com"></script>

</head>
<body>

<div class="topbar">
  <div class="topTitle">Info Scan — v8.5</div>
  <img class="logo" src="logo.png" alt="ROCKWOOL logo" onerror="this.style.display='none'"/>
</div>

<div class="card">
  <div style="font-weight:700;margin-bottom:8px;">Scanner</div>
  <div id="cameraWrap">
      <div id="qr-reader"></div>
  </div>
  <button id="scanBtn" class="btn">START SCANNING</button>
</div>

<div class="card" style="position:relative;">
  <div style="font-weight:700;margin-bottom:10px;font-size:18px;">Rådata</div>
  <div id="output"></div>
  <button id="copyBtn" disabled>KOPIER</button>
</div>

<script>
const scanBtn = document.getElementById('scanBtn');
const output  = document.getElementById('output');
const copyBtn = document.getElementById('copyBtn');
const cameraWrap = document.getElementById('cameraWrap');
const qrCodeRegionId = "qr-reader";

let html5QrCode = null;
let isScanning = false;

function esc(s){ return String(s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'''})[m]); }
function classifyWeight(kg){
  if(kg <= 15) return {cls:'w-green', extra:''};
  if(kg <= 30) return {cls:'w-yellow', extra:' (Pas på når du løfter)'};
  return {cls:'w-red', extra:' (Brug hjælpe værktøj til løft)'};
}
function enableCopy(enable){ copyBtn.disabled = !enable; }
function clearOutput(){ output.innerHTML = ''; enableCopy(false); }
function makeBox(title, valueHtml){
  const d = document.createElement('div');
  d.className = 'box';
  d.innerHTML = `<div class="catTitle">${esc(title)}</div><div class="boxValue">${valueHtml}</div>`;
  return d;
}
function makeKemiBox(title, valueHtml, showHazard){
  const d = document.createElement('div');
  d.className = 'box';
  d.innerHTML = `<div class="catTitle">${esc(title)}</div>
    <div class="kemiRow">
      <div class="boxValue">${valueHtml}</div>
      ${showHazard? `<svg class="hazard" viewBox="0 0 400 400">
        <polygon points="200,20 380,200 200,380 20,200" fill="white" stroke="#d32f2f" stroke-width="35"/>
        <circle cx="200" cy="270" r="35" fill="black"/>
        <rect x="182" y="90" width="36" height="140" rx="18" fill="black"/>
      </svg>` : '' }
    </div>`;
  return d;
}

function parseRaw(raw){
  console.log("Parsing raw data:", raw); // Debugging
  const lines = String(raw||"").split(/\r?\n/).map(l=>l.trim()).filter(l=>l);
  const data = {};
  let collecting=false;
  let andenArr=[];
  const known = ['Område','Varenummer','Materiale','Antal','Længde','Bredde','Tykkelse','Vægt',
                 'Areal i m²','Anden info','Lager/Område','Reol','Hylde','Plads','Kemi','Meter'];
  for(let i=0;i<lines.length;i++){
    const line = lines[i];
    if(/^Anden info/i.test(line)){
      collecting = true;
      const parts=line.split(':');
      if(parts.length>1) andenArr.push(parts.slice(1).join(':').trim());
      continue;
    }
    if(collecting){
      if(/^[A-Za-z].*?:/.test(line)){
        const maybeKey = line.split(':')[0].trim(); // Fixed index logic
        if(known.includes(maybeKey)){ collecting = false; i--; continue; }
      }
      andenArr.push(line);
      continue;
    }
    if(line.includes(':')){
      const parts=line.split(':');
      data[parts[0].trim()] = parts.slice(1).join(':').trim(); // Fixed index logic
    } else {
      const lastKey = Object.keys(data).slice(-1)[0]; // Fixed index logic
      if(lastKey){ data[lastKey] = (data[lastKey] + '\n' + line).trim(); }
      else { data['_extra'] = (data['_extra'] ? data['_extra'] + '\n' : '') + line; }
    }
  }
  if(andenArr.length) data['Anden info'] = andenArr.join('\n');
  console.log("Parsed data object:", data); // Debugging
  return data;
}

function renderData(data){
  console.log("Rendering data:", data); // Debugging
  clearOutput();
  const boxes = [
    {title:'Område', keys:['Område']},
    {title:'Varenummer', keys:['Varenummer']},
    {title:'Materiale', keys:['Materiale']},
    {title:'Antal', keys:['Antal']},
    {title:'Mål', keys:['Længde','Bredde','Tykkelse']},
    {title:'Vægt', keys:['Vægt']},
    {title:'Areal i m²', keys:['Areal i m²']},
    {title:'Anden info', keys:['Anden info']},
    {title:'Lagerplacering', keys:['Lager/Område','Reol','Hylde','Plads']}, 
    {title:'Kemi', keys:['Kemi']}
  ];
  let unFound = false;
  Object.values(data).forEach(v => { if(/\bUN\d+/.test(v)) unFound = true; });
  boxes.forEach(box => {
    const present = box.keys.filter(k => (k in data) && String(data[k]).trim() !== '');
    if(!present.length) return;
    
    if(box.title === 'Mål'){
      const arr = [];
      ['Længde','Bredde','Tykkelse'].forEach(k => { if(k in data) arr.push(`${k}: ${esc(data[k])}`); });
      output.appendChild(makeBox(box.title, arr.join('\n')));
      return;
    }
    if(box.title === 'Vægt'){
      const raw = data['Vægt'] ? String(data['Vægt']).trim() : '';
      const m = raw.match(/([\d\.,]+)/);
      let kg = null;
      if(m) kg = parseFloat(m[1].replace(',','.')); // Fixed index logic
      let cls = '', txt = esc(raw);
      if(kg !== null && !isNaN(kg)){
        const inf = classifyWeight(kg);
        cls = inf.cls;
        txt = `${kg} kg${inf.extra}`;
      }
      output.appendChild(makeBox(box.title, `<span class="${cls}">${txt}</span>`));
      return;
    }
    if(box.title === 'Anden info'){
      output.appendChild(makeBox(box.title, esc(data['Anden info'] || '')));
      return;
    }
    if(box.title === 'Lagerplacering'){
      const arr = [];
      ['Lager/Område','Reol','Hylde','Plads'].forEach(k => { 
          if(k in data && k !== 'Lagerplads') arr.push(`${k}: ${esc(data[k])}`); 
      });
      if(arr.length) {
        output.appendChild(makeBox(box.title, arr.join('\n')));
      }
      return;
    }
    if(box.title === 'Kemi'){
      const v = esc(data['Kemi'] || '');
      output.appendChild(makeKemiBox('Kemi', v, unFound || /\bUN\d+/.test(v)));
      return;
    }
    output.appendChild(makeBox(box.title, esc(data[box.keys[0]] || ''))); // Fixed index logic
  });
  enableCopy(true);
}

// --- Scanningslogik ---

function onScanSuccess(decodedText, decodedResult) {
  stopScanning(); 
  console.log(`Scan success: ${decodedText}`, decodedResult);
  const parsedData = parseRaw(decodedText);
  renderData(parsedData);
}

function onScanError(error) {
  // console.warn(`Scan error: ${error}`);
}

async function startScanning() {
  console.log("startScanning function called."); // Debugging
  if (isScanning) return;
  clearOutput();
  scanBtn.textContent = 'STOP SCANNING';
  isScanning = true;

  if (!html5QrCode) {
    html5QrCode = new Html5Qrcode(qrCodeRegionId);
  }
  const config = {
    fps: 10,
    qrbox: { width: 250, height: 250 },
    aspectRatio: 1.0,
    disableFlip: false
  };

  try {
    console.log("Attempting to start camera..."); // Debugging
    await html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanError);
    console.log("Camera started successfully."); // Debugging
  } catch (err) {
    console.error("Kunne ikke starte kameraet:", err); // Debugging
    output.appendChild(makeBox("Fejl", "Kunne ikke starte kameraet. Sørg for at give tilladelse."));
    stopScanning();
  }
}

async function stopScanning() {
  console.log("stopScanning function called."); // Debugging
  if (!isScanning || !html5QrCode) return;
  try {
    await html5QrCode.stop();
    console.log("Camera stopped successfully."); // Debugging
  } catch (err) {
    console.warn("Fejl ved stop af scanner:", err);
  }
  html5QrCode.clear();
  scanBtn.textContent = 'START SCANNING';
  isScanning = false;
}

// Event listeners
scanBtn.addEventListener('click', () => {
  console.log("Scan button clicked."); // Debugging
  if (isScanning) {
    stopScanning();
  } else {
    startScanning();
  }
});

copyBtn.addEventListener('click', () => {
    const rawText = output.innerText;
    navigator.clipboard.writeText(rawText).then(() => {
        alert('Data kopieret til udklipsholder!');
    }).catch(err => {
        console.error('Kunne ikke kopiere tekst: ', err);
    });
});

</script>

</body>
</html>
