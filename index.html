<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Info Scan — v7.6</title>

<style>
  :root{
    --rw-red:#D20014;
    --text:#111827;
    --black:#000;
    --un:#b91c1c;
    --green:#059669;
    --yellow:#CA8A04;
    --red:#B91C1C;
  }

  body{
    margin:0;
    padding:12px;
    font-family: Arial, ui-monospace, monospace;
    background:var(--rw-red);
    color:var(--text);
  }

  .topbar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:12px;
  }
  .topTitle{
    color:#fff;
    font-weight:900;
    font-size:20px;
  }
  .logo{
    height:70px;
    display:block;
  }

  .card{
    background:#fff;
    border-radius:12px;
    padding:14px;
    margin-bottom:14px;
  }

  #cameraWrap{
    height:260px;
    border-radius:10px;
    background:#f3f4f6;
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
    color:#9ca3af;
  }

  #cameraWrap video{
    width:100%;
    height:100%;
    object-fit:cover;
  }

  .btn{
    width:100%;
    height:56px;
    margin-top:16px;
    border:none;
    border-radius:10px;
    background:#111827;
    color:white;
    font-weight:900;
    font-size:18px;
    cursor:pointer;
  }

  #copyBtn{
    width:100%;
    height:50px;
    margin-top:14px;
    border-radius:10px;
    border:2px solid #ddd;
    background:white;
    font-weight:900;
    font-size:16px;
    cursor:pointer;
  }

  .box{
    border:2px solid var(--black);
    border-radius:6px;
    padding:10px 12px;
    margin-bottom:12px;
    background:white;
  }

  .catTitle{
    font-size:17px;
    font-weight:900;
    margin-bottom:8px;
  }

  .boxValue{
    font-family: ui-monospace, monospace;
    font-size:16px;
    white-space:pre-wrap;
  }

  .w-green{ color:var(--green); font-weight:900; }
  .w-yellow{ color:var(--yellow); font-weight:900; }
  .w-red{ color:var(--red); font-weight:900; }

  .kemiRow{
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .hazard{
    width:34px;
    height:34px;
  }

</style>
</head>
<body>

<div class="topbar">
  <div class="topTitle">Info Scan — v7.6</div>
  <img src="logo.png" class="logo" onerror="this.style.display='none'"/>
</div>

<div class="card">
  <div style="font-weight:700;margin-bottom:8px;">Scanner</div>
  <div id="cameraWrap">Kamera er slukket</div>
  <button id="scanBtn" class="btn">NY SCANNING</button>
</div>

<div class="card" style="position:relative;">
  <div style="font-weight:700;margin-bottom:10px;font-size:18px;">Rådata</div>
  <div id="output"></div>
  <button id="copyBtn">KOPIER</button>
</div>

<script>
/* ---------- GLOBALS ---------- */
let videoEl=null, stream=null, canvas=null, ctx=null, raf=null;

const scanBtn = document.getElementById("scanBtn");
const output  = document.getElementById("output");
const copyBtn = document.getElementById("copyBtn");

/* ---------- HELPERS ---------- */
function esc(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }

function classifyWeight(kg){
  if(kg <= 15) return {cls:'w-green', extra:''};
  if(kg <= 30) return {cls:'w-yellow', extra:' (Pas på når du løfter)'};
  return {cls:'w-red', extra:' (Brug hjælpe værktøj til løft)'};
}

function clearOutput(){
  output.innerHTML = '';
  copyBtn.disabled = true;
}

/* ---------- PARSER ---------- */
function parseRaw(raw){
  const lines = String(raw||"").split(/\r?\n/).map(l=>l.trim()).filter(l=>l);
  const data={};
  let andenInfo=[], collecting=false;

  const known = ['Område','Varenummer','Materiale','Antal',
    'Længde','Bredde','Tykkelse','Vægt','Areal i m²','Anden info',
    'Lagerplads','Lager/Område','Reol','Hylde','Plads','Kemi','Meter'];

  for(let i=0;i<lines.length;i++){
    let line=lines[i];

    if(/^Anden info/i.test(line)){
      collecting=true;
      const p=line.split(":");
      if(p[1]) andenInfo.push(p[1].trim());
      continue;
    }

    if(collecting){
      if(/^[A-Za-z].*?:/.test(line)){
        const key=line.split(":")[0].trim();
        if(known.includes(key)){
          collecting=false;
          i--;
          continue;
        }
      }
      andenInfo.push(line);
      continue;
    }

    if(line.includes(":")){
      const p=line.split(":");
      data[p[0].trim()] = p.slice(1).join(":").trim();
    }
  }

  if(andenInfo.length) data["Anden info"]=andenInfo.join("\n");
  return data;
}

/* ---------- RENDER ---------- */
function renderData(data){
  clearOutput();

  const boxes = [
    {title:'Område', keys:['Område']},
    {title:'Varenummer', keys:['Varenummer']},
    {title:'Materiale', keys:['Materiale']},
    {title:'Antal', keys:['Antal']},
    {title:'Mål', keys:['Længde','Bredde','Tykkelse']},
    {title:'Vægt', keys:['Vægt']},
    {title:'Areal i m²', keys:['Areal i m²']},
    {title:'Anden info', keys:['Anden info']},
    {title:'Lagerplads', keys:['Lagerplads','Lager/Område','Reol','Hylde','Plads']},
    {title:'Kemi', keys:['Kemi']}
  ];

  let unFound=false;
  Object.values(data).forEach(v=>{ if(/\bUN\d+/.test(v)) unFound=true; });

  boxes.forEach(box=>{
    const present = box.keys.filter(k => k in data && data[k].trim()!=="");
    if(!present.length) return;

    /* MÅL */
    if(box.title==='Mål'){
      const arr=[];
      present.forEach(k=>arr.push(`${k}: ${esc(data[k])}`));
      output.appendChild(makeBox(box.title, arr.join("\n")));
      return;
    }

    /* VÆGT */
    if(box.title==='Vægt'){
      const raw=data['Vægt'];
      let kg=parseFloat(raw.replace(",","."));
      let cls='', txt=esc(raw);
      if(!isNaN(kg)){
        const inf=classifyWeight(kg);
        cls=inf.cls;
        txt=`${kg} kg${inf.extra}`;
      }
      output.appendChild(makeBox(box.title, `<span class="${cls}">${txt}</span>`));
      return;
    }

    /* ANDEN INFO */
    if(box.title==='Anden info'){
      output.appendChild(makeBox(box.title, esc(data['Anden info'])));
      return;
    }

    /* LAGERPLADS */
    if(box.title==='Lagerplads'){
      const arr=[];
      present.forEach(k => arr.push(`${k}: ${esc(data[k])}`));
      output.appendChild(makeBox(box.title, arr.join("\n")));
      return;
    }

    /* KEMI */
    if(box.title==='Kemi'){
      const v=esc(data['Kemi']);
      output.appendChild(makeKemiBox("Kemi", v, unFound));
      return;
    }

    /* DEFAULT */
    const key=present[0];
    output.appendChild(makeBox(box.title, esc(data[key])));
  });

  copyBtn.disabled=false;
}

/* ---------- BOX BUILDERS ---------- */

function makeBox(title, valueHtml){
  const d=document.createElement("div");
  d.className="box";
  d.innerHTML = `
    <div class="catTitle">${esc(title)}</div>
    <div class="boxValue">${valueHtml}</div>`;
  return d;
}

function makeKemiBox(title, valueHtml, showHazard){
  const box=document.createElement("div");
  box.className="box";
  box.innerHTML = `
    <div class="catTitle">${esc(title)}</div>
    <div class="kemiRow">
      <div class="boxValue">${valueHtml}</div>
      ${showHazard? hazardSvg() : ""}
    </div>`;
  return box;
}

function hazardSvg(){
  return `<svg class="hazard" viewBox="0 0 400 400">
      <polygon points="200,20 380,200 200,380 20,200"
        fill="white" stroke="#d32f2f" stroke-width="35"/>
      <circle cx="200" cy="270" r="35" fill="black"/>
      <rect x="182" y="90" width="36" height="140" rx="18" fill="black"/>
    </svg>`;
}

/* ---------- CAMERA ---------- */

async function loadJsQR(){
  if(window.jsQR) return;
  return new Promise(resolve=>{
    const s=document.createElement('script');
    s.src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js";
    s.onload=resolve;
    document.head.appendChild(s);
  });
}

async function startCamera(){
  if(!videoEl){
    videoEl=document.createElement("video");
    videoEl.setAttribute("playsinline","true");
  }
  if(!canvas){
    canvas=document.createElement("canvas");
    ctx=canvas.getContext("2d");
  }
  try{
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:"environment"}},audio:false});
    videoEl.srcObject=stream;
    await videoEl.play();
    const cw=document.getElementById("cameraWrap");
    cw.innerHTML="";
    cw.appendChild(videoEl);
    return true;
  }catch(e){
    return false;
  }
}

function stopCamera(){
  if(raf) cancelAnimationFrame(raf);
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  if(videoEl){ try{ videoEl.pause(); }catch(e){} videoEl.srcObject=null; }
  document.getElementById("cameraWrap").innerHTML="Kamera er slukket";
}

async function scanLoop(){
  if(!videoEl || videoEl.readyState!==videoEl.HAVE_ENOUGH_DATA){
    raf=requestAnimationFrame(scanLoop);
    return;
  }
  if(canvas.width!==videoEl.videoWidth){
    canvas.width=videoEl.videoWidth;
    canvas.height=videoEl.videoHeight;
  }
  ctx.drawImage(videoEl,0,0);
  const img=ctx.getImageData(0,0,canvas.width,canvas.height);
  let code=null;
  if(window.jsQR) code=jsQR(img.data,img.width,img.height);
  if(code && code.data){
    stopCamera();
    const parsed=parseRaw(code.data);
    renderData(parsed);
    return;
  }
  raf=requestAnimationFrame(scanLoop);
}

/* ---------- BUTTON ---------- */

scanBtn.onclick = async()=>{
  clearOutput();
  await loadJsQR();
  const ok=await startCamera();
  if(!ok){
    const demo=`Område: Demo
Varenummer: 12345
Materiale: Demo
Antal: 3 PL
Længde: 1200
Bredde: 600
Tykkelse: 50
Vægt: 18
Areal i m²: 6.5
Anden info: prøve
andet felt
Lager/Område: SYM01
Reol: 02
Hylde: 03
Plads: 04
Kemi: UN1209`;
    renderData(parseRaw(demo));
    return;
  }
  scanLoop();
};

window.addEventListener("beforeunload", stopCamera);
</script>
</body>
</html>
