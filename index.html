<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Info Scan — v6.8</title>

<style>
  :root{
    --rw-red: #D20014;
    --text: #111827;
    --muted: #6b7280;

    --green: #059669;
    --yellow: #CA8A04;
    --red: #B91C1C;
  }

  body{
    margin:0;
    background:var(--rw-red);
    font-family: Arial, monospace;
    color:var(--text);
  }

  /* TOP LOGO BAR */
  .top{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:18px 20px;
    background:var(--rw-red);
    color:white;
    font-size:22px;
    font-weight:700;
  }

  .logo{
    height:34px;
  }

  .container{
    padding:14px;
  }

  .card{
    background:white;
    border-radius:14px;
    padding:16px;
    margin-bottom:14px;
  }

  #cameraWrap{
    height:260px;
    border-radius:14px;
    background:#f3f4f6;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:20px;
    color:#9ca3af;
    overflow:hidden;
  }

  #cameraWrap video{
    width:100%;
    height:100%;
    object-fit:cover;
  }

  .btn{
    width:100%;
    height:56px;
    background:#0f172a;
    color:white;
    border:0;
    border-radius:14px;
    font-size:20px;
    font-weight:700;
    margin-top:16px;
    cursor:pointer;
  }

  /* RAW DATA SECTION */
  .section-title{
    font-weight:700;
    margin-top:20px;
    margin-bottom:8px;
    font-size:22px;
  }

  .cat{
    font-weight:700;
    margin-top:18px;
    font-size:20px;
  }

  .line{
    border-bottom:3px solid #000;
    margin:8px 0 14px 0;
  }

  .value{
    font-size:20px;
    white-space:pre-line;
  }

  .weight-green{ color:var(--green);font-weight:700; }
  .weight-yellow{ color:var(--yellow);font-weight:700; }
  .weight-red{ color:var(--red);font-weight:700; }

  #hazardIcon{
    width:40px;
    height:40px;
    position:absolute;
    right:10px;
    bottom:10px;
    display:none;
  }

  #rawBox{
    position:relative;
  }

  #copyBtn{
    margin-top:20px;
    width:100%;
    height:50px;
    border-radius:12px;
    border:2px solid #ddd;
    font-size:20px;
    font-weight:700;
    background:white;
    color:#111;
    cursor:pointer;
  }

</style>
</head>

<body>

<!-- TOP -->
<div class="top">
  <span>Info Scan</span>
  <img class="logo" src="rw-logo.png" alt="">
</div>

<div class="container">

  <!-- SCANNER -->
  <div class="card">
    <div style="font-size:22px;font-weight:700;">Scanner</div>
    <div id="cameraWrap">Kamera er slukket</div>

    <button class="btn" id="scanBtn">NY SCANNING</button>
  </div>

  <!-- RAW DATA -->
  <div class="card" id="rawBox">
    <div class="section-title">Rådata</div>

    <div id="dataFields"></div>

    <svg id="hazardIcon" viewBox="0 0 400 400">
      <polygon points="200,20 380,200 200,380 20,200"
        fill="white" stroke="#d32f2f" stroke-width="35"/>
      <circle cx="200" cy="270" r="35" fill="black"/>
      <rect x="182" y="90" width="36" height="140" rx="18" fill="black"/>
    </svg>

    <button id="copyBtn">KOPIER</button>
  </div>
</div>


<script>
/* CAMERA + QR LOGIC */
let video=null, stream=null, canvas=null, ctx=null, scanning=false;

/* CATEGORY ORDER */
const ORDER=[
  "Område","Varenummer","Materiale","Antal",
  "L","B","T","Vægt","Meter","Areal m²","Anden info",
  "Lager/Område","Reol","Hylde","Plads","Kemi"
];

function classifyWeight(kg){
  if(kg <= 15) return {cls:"weight-green",extra:""};
  if(kg <= 30) return {cls:"weight-yellow",extra:" (Pas på når du løfter)"};
  return {cls:"weight-red",extra:" (Brug hjælpe værktøj til løft)"};
}

function clearRaw(){
  document.getElementById("dataFields").innerHTML="";
  document.getElementById("hazardIcon").style.display="none";
}

/* PARSE RAW DATA */
function parseRaw(raw){

  clearRaw();

  const out={};
  const lines = String(raw).split(/\r?\n/).map(l=>l.trim()).filter(l=>l);

  let collectAndenInfo = false;
  let andenInfoText = [];

  lines.forEach(l=>{
    if(/^Anden info/i.test(l)){
      collectAndenInfo=true;
      const parts=l.split(":");
      if(parts[1]) andenInfoText.push(parts[1].trim());
      return;
    }
    if(collectAndenInfo){
      if(/^[A-Za-z]/.test(l)) andenInfoText.push(l);
      return;
    }
    const p=l.split(":");
    if(p.length>=2){
      const key=p[0].trim();
      const val=p.slice(1).join(":").trim();
      out[key]=val;
    }
  });

  if(andenInfoText.length>0){
    out["Anden info"]=andenInfoText.join("\n");
  }

  if(/UN\d+/i.test(raw)){
    document.getElementById("hazardIcon").style.display="block";
  }

  drawParsed(out);
}

function drawParsed(obj){
  const box=document.getElementById("dataFields");

  ORDER.forEach(key=>{
    if(!(key in obj)) return;

    const wrap=document.createElement("div");

    const cat=document.createElement("div");
    cat.className="cat";
    cat.textContent=key;
    wrap.appendChild(cat);

    const line=document.createElement("div");
    line.className="line";
    wrap.appendChild(line);

    const val=document.createElement("div");
    val.className="value";

    let txt=obj[key];

    if(/^Vægt/i.test(key)){
      let kg=parseFloat(String(txt).replace(",","."));
      if(!isNaN(kg)){
        const info=classifyWeight(kg);
        val.classList.add(info.cls);
        txt = kg+" kg"+info.extra;
      }
    }

    val.textContent=txt;
    wrap.appendChild(val);

    box.appendChild(wrap);
  });
}

/* COPY */
document.getElementById("copyBtn").onclick=function(){
  const text=document.getElementById("dataFields").innerText;
  navigator.clipboard.writeText(text);
  this.textContent="KOPIERET";
  setTimeout(()=>this.textContent="KOPIER",800);
};

/* CAMERA */
async function startCamera(){
  if(!video){
    video=document.createElement("video");
    video.setAttribute("playsinline","true");
  }
  if(!canvas){
    canvas=document.createElement("canvas");
    ctx=canvas.getContext("2d");
  }

  try{
    stream=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:"environment"},
      audio:false
    });
  } catch(e){
    parseRaw("Demo\nVægt: 18\nKemi: UN1209\nAnden info: Test");
    scanning=false;
    return;
  }

  video.srcObject=stream;
  await video.play();

  const wrap=document.getElementById("cameraWrap");
  wrap.innerHTML="";
  wrap.appendChild(video);

  scanLoop();
}

async function scanLoop(){
  if(!video || video.readyState!==video.HAVE_ENOUGH_DATA){
    requestAnimationFrame(scanLoop);
    return;
  }

  if(canvas.width!==video.videoWidth){
    canvas.width=video.videoWidth;
    canvas.height=video.videoHeight;
  }

  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  const img=ctx.getImageData(0,0,canvas.width,canvas.height);

  if(window.jsQR){
    const code=jsQR(img.data, img.width, img.height);
    if(code && code.data){
      stopCamera();
      parseRaw(code.data);
      return;
    }
  }

  requestAnimationFrame(scanLoop);
}

function stopCamera(){
  if(stream) stream.getTracks().forEach(t=>t.stop());
  stream=null;
}

/* LOAD jsQR */
function loadJsQR(){
  return new Promise(res=>{
    if(window.jsQR) return res();
    let s=document.createElement("script");
    s.src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js";
    s.onload=res;
    document.body.appendChild(s);
  });
}

/* START SCAN BUTTON */
document.getElementById("scanBtn").onclick=async()=>{
  clearRaw();
  document.getElementById("cameraWrap").textContent="Kamera starter…";

  await loadJsQR();
  startCamera();
};

</script>
</body>
</html>
