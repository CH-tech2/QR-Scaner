<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>QR Scanner v2.8</title>
<style>
  :root{
    --bg: #f9fafb;
    --text: #111827;
    --muted: #6b7280;
    --un-color: #b91c1c;
  }

  body{
    background: var(--bg);
    color: var(--text);
    font-family: Arial, monospace;
    margin: 20px;
  }

  h1 { font-size:18px; margin:0 0 12px 0; }
  .container{ display:grid; grid-template-columns:1fr 1fr; gap:20px; align-items:start; }
  .card{ background:#fff; border:1px solid #e6e8eb; border-radius:10px; padding:16px; }

  #cameraWrap{
    background:#f3f4f6;
    border-radius:8px;
    height:260px;
    display:flex;
    align-items:center;
    justify-content:center;
    color:#9ca3af;
    overflow:hidden;
  }
  #cameraWrap video{
    width:100%; height:100%;
    object-fit:cover;
    transform:none !important;
    -webkit-transform:none !important;
  }

  .raw-box{
    background:#fff;
    border-radius:8px;
    padding:0;
    border:1px solid #e5e7eb;
    overflow:auto;
  }
  .qr-lines div{
    padding:8px 10px;
    border-bottom:2px solid #111;
    font-family: ui-monospace, monospace;
    font-size:15px;
    white-space:pre-wrap;
  }
  .qr-lines .un{
    color: var(--un-color);
    font-weight:700;
  }

  .btn-row{ display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; }
  .btn{
    width:140px;
    height:48px;
    border-radius:8px;
    border:0;
    cursor:pointer;
    font-weight:700;
    font-size:16px;
    display:flex;
    align-items:center;
    justify-content:center;
    background:#111827;
    color:#fff;
  }
  .btn.ghost{ background:#fff; color:#111827; border:1px solid #d1d5db; }
  .btn:disabled{ opacity:0.45; cursor:not-allowed; }

  .status{ color:var(--muted); font-size:14px; }

  @media(max-width:900px){
    .container{ grid-template-columns:1fr; }
  }
</style>
</head>
<body>
<h1>QR Scanner — v2.8</h1>

<div class="container">
  <div class="card">
    <strong>Scanner</strong>
    <div id="cameraWrap">Kamera preview</div>

    <div class="btn-row">
      <button class="btn" id="startBtn">START SCANNING</button>
      <button class="btn ghost" id="newBtn" style="display:none;">NY SCANNING</button>
      <div class="status" id="scanStatus"></div>
    </div>
  </div>

  <div class="card">
    <strong>Rådata</strong>

    <div class="raw-box" style="margin-top:10px;">
      <div id="rawLines" class="qr-lines"></div>
    </div>

    <div class="btn-row">
      <button class="btn ghost" id="copyBtn" disabled>KOPIER</button>
    </div>
  </div>
</div>

<script>
/* QR Scanner v2.8 */

/* Elements */
const startBtn = document.getElementById('startBtn');
const newBtn   = document.getElementById('newBtn');
const copyBtn  = document.getElementById('copyBtn');
const scanStatus = document.getElementById('scanStatus');
const cameraWrap = document.getElementById('cameraWrap');
const rawLines = document.getElementById('rawLines');

let stream = null;
let videoEl = null;
let canvas = null;
let ctx = null;
let scanning = false;
let rafId = null;

/* Utilities */
function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[m]));
}

function normalizeRawText(raw){
  return String(raw||'')
    .split(/\r?\n/)
    .map(l=>l.trim())
    .filter(l=>l!=='')
    .join('\n');
}

/* NEW UN REGEX — v2.8 */
function highlightUN(str){
  return String(str).replace(
    /\b(UN\d+(?:,\d+)+|UN\d+)\b/g,
    '<span class="un">$1</span>'
  );
}

/* UI states */
function showStartOnly(){
  startBtn.style.display = 'inline-flex';
  newBtn.style.display = 'none';
  copyBtn.disabled = (rawLines.innerText.trim() === '');
  scanStatus.textContent = '';
}
function showDuringScanning(){
  startBtn.style.display = 'none';
  newBtn.style.display = 'inline-flex';
  copyBtn.disabled = true;
  scanStatus.textContent = 'SCANNING…';
}
function showAfterScan(){
  startBtn.style.display = 'inline-flex';
  newBtn.style.display = 'none';
  copyBtn.disabled = (rawLines.innerText.trim() === '');
  scanStatus.textContent = '';
}

/* Set raw data */
function setRawData(raw){
  rawLines.innerHTML = '';
  const normalized = normalizeRawText(raw);

  if(!normalized){
    copyBtn.disabled = true;
    return;
  }

  normalized.split(/\r?\n/).forEach(line=>{
    const div = document.createElement('div');
    div.innerHTML = highlightUN(escapeHtml(line));
    rawLines.appendChild(div);
  });

  copyBtn.disabled = false;
}

/* Copy */
async function copyRaw(){
  try{
    await navigator.clipboard.writeText(rawLines.innerText);
    const prev = copyBtn.innerText;
    copyBtn.innerText = 'KOPIERET';
    setTimeout(()=> copyBtn.innerText = prev, 900);
  }catch(e){
    alert('Kunne ikke kopiere');
  }
}

copyBtn.addEventListener('click', copyRaw);

/* Load jsQR */
function loadJsQr(){
  return new Promise((resolve, reject)=>{
    if(window.jsQR) return resolve(window.jsQR);
    const s=document.createElement('script');
    s.src='https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js';
    s.onload = ()=> resolve(window.jsQR);
    s.onerror = ()=> reject(new Error('Kan ikke loade jsQR'));
    document.head.appendChild(s);
  });
}

/* Camera */
async function startCamera(){
  if(!videoEl){
    videoEl = document.createElement('video');
    videoEl.setAttribute('playsinline','true');
    videoEl.style.width='100%';
    videoEl.style.height='100%';
  }
  if(!canvas){
    canvas=document.createElement('canvas');
    ctx=canvas.getContext('2d');
  }

  try{
    stream = await navigator.mediaDevices.getUserMedia({
      video:{facingMode:{ideal:'environment'}},
      audio:false
    });
    videoEl.srcObject = stream;
    await videoEl.play();
    cameraWrap.innerHTML='';
    cameraWrap.appendChild(videoEl);
    return true;
  }catch(e){
    return false;
  }
}

function stopCamera(){
  if(rafId){ cancelAnimationFrame(rafId); rafId=null; }
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  cameraWrap.innerHTML='Kamera er slukket';
}

/* Scan loop */
async function scanLoop(){
  if(!videoEl || videoEl.readyState !== videoEl.HAVE_ENOUGH_DATA){
    rafId=requestAnimationFrame(scanLoop);
    return;
  }

  if(canvas.width !== videoEl.videoWidth){
    canvas.width = videoEl.videoWidth;
    canvas.height = videoEl.videoHeight;
  }

  ctx.drawImage(videoEl,0,0,canvas.width,canvas.height);
  const img = ctx.getImageData(0,0,canvas.width,canvas.height);

  let code = null;
  try{
    if(window.jsQR) code = jsQR(img.data, img.width, img.height);
  }catch(e){}

  if(code && code.data){
    setRawData(code.data);
    scanning=false;
    stopCamera();
    showAfterScan();
    return;
  }

  rafId=requestAnimationFrame(scanLoop);
}

/* START */
async function startScanning(){
  if(scanning) return;
  scanning = true;
  showDuringScanning();

  try{ await loadJsQr(); }catch(e){}

  const ok = await startCamera();
  if(!ok){
    const demo='Område: KONF\nVarenummer: 50023166\nMateriale: Tape\nAntal: 18\nKemi: UN1725,1,11';
    setTimeout(()=>{ setRawData(demo); scanning=false; showAfterScan(); },600);
    return;
  }

  showDuringScanning();
  scanLoop();
}

/* NY SCANNING */
function newScanning(){
  rawLines.innerHTML='';
  copyBtn.disabled=true;
  scanStatus.textContent='SCANNING…';
  if(!stream) startScanning();
  else{
    showDuringScanning();
    if(!rafId) scanLoop();
  }
}

startBtn.addEventListener('click', startScanning);
newBtn.addEventListener('click', newScanning);

/* init */
showStartOnly();
window.addEventListener('beforeunload', stopCamera);
</script>
</body>
</html>
