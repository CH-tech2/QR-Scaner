<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Info Scan v3.7 FIX</title>

<style>
  :root{
    --bg: #D20014;
    --text: #111827;
    --muted: #6b7280;
    --un-color: #b91c1c;
    --weight-green: #059669;
    --weight-yellow: #CA8A04;
    --weight-red: #B91C1C;
  }

  body{
    background: var(--bg);
    color: var(--text);
    font-family: Arial, monospace;
    margin: 20px;
  }

  h1{color:white;margin-bottom:12px;}

  .container{display:grid;grid-template-columns:1fr 1fr;gap:20px;}
  .card{background:white;border-radius:10px;padding:16px;}

  #cameraWrap{
    background:#f3f4f6;
    border-radius:8px;
    height:260px;
    display:flex;
    justify-content:center;
    align-items:center;
    color:#9ca3af;
    overflow:hidden;
  }

  #cameraWrap video{
    width:100%;height:100%;
    object-fit:cover;
    transform:none !important;
    -webkit-transform:none !important;
  }

  .raw-box{background:white;border:1px solid #ddd;border-radius:8px;position:relative;}
  .qr-lines div{
    padding:8px 10px;
    border-bottom:2px solid #111;
    font-family:ui-monospace, monospace;
    font-size:15px;
  }

  .qr-lines .un{color:var(--un-color);font-weight:700;}

  .btn-row{display:flex;gap:10px;margin-top:12px;}
  .btn{
    width:140px;height:48px;
    border-radius:8px;border:0;
    font-weight:700;font-size:16px;
    background:#111827;color:white;
    display:flex;justify-content:center;align-items:center;
  }

  .btn.ghost{background:white;color:#111;border:1px solid #d1d5db;}

  .status{color:white;font-size:14px;}

  @media(max-width:900px){.container{grid-template-columns:1fr;}}
</style>
</head>

<body>
<h1>Info Scan — v3.7</h1>

<div class="container">
  <div class="card">
    <strong>Scanner</strong>
    <div id="cameraWrap">Kamera slukket</div>

    <div class="btn-row">
      <button class="btn" id="startBtn">START SCANNING</button>
      <button class="btn ghost" id="newBtn" style="display:none;">NY SCANNING</button>
      <div class="status" id="scanStatus"></div>
    </div>
  </div>

  <div class="card">
    <strong>Rådata</strong>
    <div class="raw-box" style="margin-top:10px;">
      <div id="rawLines" class="qr-lines"></div>

      <!-- HAZARD ICON -->
      <svg id="hazardIcon" viewBox="0 0 400 400" style="display:none;position:absolute;bottom:6px;right:6px;width:38px;height:38px;">
        <polygon points="200,20 380,200 200,380 20,200" fill="white" stroke="#d32f2f" stroke-width="35"/>
        <circle cx="200" cy="270" r="35" fill="black"/>
        <rect x="182" y="90" width="36" height="140" rx="18" fill="black"/>
      </svg>
    </div>

    <div class="btn-row">
      <button class="btn ghost" id="copyBtn" disabled>KOPIER</button>
    </div>
  </div>
</div>

<script>
// ---- GLOBALS ----
let stream=null, video=null, canvas=null, ctx=null;
let scanning=false, rafId=null;

const startBtn=document.getElementById("startBtn");
const newBtn=document.getElementById("newBtn");
const copyBtn=document.getElementById("copyBtn");
const rawLines=document.getElementById("rawLines");
const hazardIcon=document.getElementById("hazardIcon");
const status=document.getElementById("scanStatus");

// ---- HELPERS ----
function escapeHtml(s){return s.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));}
function normalizeText(raw){return raw.split(/\n/).map(l=>l.trim()).filter(l=>l).join("\n");}
function highlightUN(t){return t.replace(/\b(UN\d+(?:,\d+)*)\b/g,'<span class="un">$1</span>');}

// ---- RAW DATA ----
function setRawData(raw){
  rawLines.innerHTML="";
  hazardIcon.style.display="none";
  let txt=normalizeText(raw);
  if(!txt){copyBtn.disabled=true;return;}

  if(/\bUN\d+/.test(txt)){hazardIcon.style.display="block";}

  txt.split("\n").forEach(line=>{
    let div=document.createElement("div");
    div.innerHTML=highlightUN(escapeHtml(line));
    rawLines.appendChild(div);
  });

  copyBtn.disabled=false;
}

// ---- CAMERA ----
async function startCamera(){
  video=document.createElement("video");
  video.setAttribute("playsinline","true");

  try{
    stream=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:{ideal:"environment"}},audio:false
    });
  }catch(e){
    alert("Kamera kan ikke startes.");
    return false;
  }

  video.srcObject=stream;
  await video.play();

  const wrap=document.getElementById("cameraWrap");
  wrap.innerHTML="";
  wrap.appendChild(video);

  canvas=document.createElement("canvas");
  ctx=canvas.getContext("2d");

  return true;
}

function stopCamera(){
  if(rafId) cancelAnimationFrame(rafId);
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
    stream=null;
  }
  const wrap=document.getElementById("cameraWrap");
  wrap.innerHTML="Kamera slukket";
}

// ---- SCANNING LOOP ----
async function loop(){
  if(video.readyState===video.HAVE_ENOUGH_DATA){
    canvas.width=video.videoWidth;
    canvas.height=video.videoHeight;
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
    let img=ctx.getImageData(0,0,canvas.width,canvas.height);

    let code=window.jsQR? jsQR(img.data,img.width,img.height) : null;

    if(code){
      scanning=false;
      stopCamera();
      setRawData(code.data);
      startBtn.style.display="inline-flex";
      newBtn.style.display="none";
      status.textContent="";
      return;
    }
  }
  if(scanning) rafId=requestAnimationFrame(loop);
}

// ---- BUTTON LOGIC ----
startBtn.onclick=async()=>{
  scanning=true;
  status.textContent="SCANNING…";

  await new Promise(res=>{
    if(window.jsQR) return res();
    let s=document.createElement("script");
    s.src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js";
    s.onload=()=>res();
    document.head.appendChild(s);
  });

  let ok=await startCamera();
  if(!ok){
    status.textContent="";
    scanning=false;
    return;
  }

  startBtn.style.display="none";
  newBtn.style.display="inline-flex";
  loop();
};

newBtn.onclick=()=>{
  rawLines.innerHTML="";
  hazardIcon.style.display="none";
  copyBtn.disabled=true;
  scanning=true;
  status.textContent="SCANNING…";
  startBtn.onclick();
};

copyBtn.onclick=async()=>{
  await navigator.clipboard.writeText(rawLines.innerText);
};
</script>

</body>
</html>
