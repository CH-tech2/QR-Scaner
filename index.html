<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Info Scan — v6.3</title>

<style>
  :root{
    --bg: #D20014;
    --text: #111;
    --un: #b91c1c;

    --green:#059669;
    --yellow:#CA8A04;
    --red:#B91C1C;
  }

  body{
    background:var(--bg);
    color:var(--text);
    font-family:Arial, monospace;
    margin:20px;
  }

  h1{color:#fff;margin:0 0 15px 0;font-size:20px;}

  .container{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:20px;
  }

  .card{
    background:#fff;
    border-radius:12px;
    padding:16px;
    border:1px solid #e5e7eb;
  }

  /* Camera area */
  #cameraWrap{
    background:#f3f4f6;
    border-radius:10px;
    height:260px;
    display:flex;
    align-items:center;
    justify-content:center;
    color:#9ca3af;
    overflow:hidden;
  }
  #cameraWrap video{
    width:100%;
    height:100%;
    object-fit:cover;
  }

  /* RAW DATA */
  .raw-box{
    background:#fff;
    border:1px solid #e5e7eb;
    border-radius:10px;
    padding:0;
    overflow:auto;
    position:relative;
  }
  .line{
    font-family:ui-monospace, monospace;
    padding:8px 10px;
    white-space:pre-wrap;
  }
  .divider{
    border-bottom:2px solid #111;
    margin:0 10px;
  }

  .un{color:var(--un);font-weight:700;}

  /* Vægt farver */
  .green{color:var(--green);font-weight:700;}
  .yellow{color:var(--yellow);font-weight:700;}
  .red{color:var(--red);font-weight:700;}

  /* Hazard icon */
  #hazardIcon{
    position:absolute;
    right:10px;
    bottom:10px;
    width:38px;
    height:38px;
    display:none;
  }

  /* Buttons */
  .btn{
    width:160px;
    height:48px;
    border-radius:8px;
    border:none;
    font-size:16px;
    font-weight:700;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .primary{background:#111827;color:#fff;}
  .ghost{background:#fff;border:1px solid #d1d5db;color:#111;}
  .disabled{opacity:.45;}

  @media(max-width:900px){
    .container{grid-template-columns:1fr;}
  }
</style>
</head>

<body>
<h1>Info Scan — v6.3</h1>

<div class="container">

  <!-- SCANNER -->
  <div class="card">
    <strong>Scanner</strong>

    <div id="cameraWrap">Kamera er slukket</div>

    <br />
    <button id="startBtn" class="btn primary">START SCANNING</button>
    <button id="newBtn" class="btn ghost" style="display:none;">NY SCANNING</button>
  </div>

  <!-- RAADATA -->
  <div class="card">
    <strong>Rådata</strong>

    <div class="raw-box" style="margin-top:10px;">
      <div id="rawLines"></div>

      <!-- Hazard icon -->
      <svg id="hazardIcon" viewBox="0 0 400 400">
        <polygon points="200,20 380,200 200,380 20,200"
         fill="white" stroke="#d32f2f" stroke-width="35"/>
        <circle cx="200" cy="270" r="35" fill="black"/>
        <rect x="182" y="90" width="36" height="140" rx="18" fill="black"/>
      </svg>
    </div>

    <br />
    <button id="copyBtn" class="btn ghost disabled" disabled>KOPIER</button>
  </div>

</div>

<script>
const startBtn = document.getElementById("startBtn");
const newBtn   = document.getElementById("newBtn");
const copyBtn  = document.getElementById("copyBtn");
const rawLines = document.getElementById("rawLines");
const hazardIcon = document.getElementById("hazardIcon");
const cameraWrap = document.getElementById("cameraWrap");

let stream=null, video=null, canvas=null, ctx=null, scanning=false;

/* HELPERS */
function escapeHtml(txt){
  return txt.replace(/[&<>"']/g,m=>(
    {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]
  ));
}
function normalize(raw){
  return raw.split(/\r?\n/).map(l=>l.trim()).filter(l=>l!="");
}
function highlightUN(s){
  return s.replace(/\b(UN\d+(?:,\d+)*)\b/g,'<span class="un">$1</span>');
}

function weightClass(line){
  const m=line.match(/Vægt:\s*([\d.,]+)/i);
  if(!m) return {cls:"", extra:""};
  let kg=parseFloat(m[1].replace(",","."));
  if(isNaN(kg)) return {cls:"", extra:""};
  if(kg<=15) return {cls:"green",extra:""};
  if(kg<=30) return {cls:"yellow",extra:" (Pas på når du løfter)"};
  return {cls:"red",extra:" (Brug hjælpe værktøj til løft)"};
}

/* GROUPING RULES */
const groups = {
  "Mål:": ["Længde","Bredde","Tykkelse"],
  "Lagerplads:": ["Lager/Område","Reol","Hylde","Plads"]
};

/* RENDER RAW DATA */
function setRawData(text){
  rawLines.innerHTML="";
  hazardIcon.style.display="none";
  if(!text) return;

  const arr = normalize(text);

  let currentGroup=null;

  arr.forEach((line,i)=>{
    const clean = escapeHtml(line);
    const html  = highlightUN(clean);

    const div = document.createElement("div");
    div.className="line";

    // check group start
    if(groups[line]){
      currentGroup=line;
      div.innerHTML = html;
      rawLines.appendChild(div);
      addDivider();
      return;
    }

    // check if inside group
    if(currentGroup){
      let keys = groups[currentGroup];
      let isSub = keys.some(k => line.startsWith(k));
      if(isSub){
        div.innerHTML = html;
        rawLines.appendChild(div);
        return; // NO divider
      } else {
        currentGroup=null;
      }
    }

    // weight highlight
    if(line.startsWith("Vægt:")){
      let w = weightClass(line);
      div.classList.add(w.cls);
      div.innerHTML = html + escapeHtml(w.extra);
    } else {
      div.innerHTML = html;
    }

    rawLines.appendChild(div);
    addDivider();
  });

  // hazard icon?
  if(/UN\d+/.test(text)) hazardIcon.style.display="block";

  copyBtn.disabled=false;
  copyBtn.classList.remove("disabled");
}

function addDivider(){
  const hr=document.createElement("div");
  hr.className="divider";
  rawLines.appendChild(hr);
}

/* COPY */
copyBtn.onclick=()=>{
  navigator.clipboard.writeText(rawLines.innerText);
  copyBtn.textContent="KOPIERET";
  setTimeout(()=>copyBtn.textContent="KOPIER",800);
};

/* CAMERA */
async function startCamera(){
  try{
    stream = await navigator.mediaDevices.getUserMedia({
      video:{facingMode:"environment"},
      audio:false
    });
  }catch(e){
    cameraWrap.textContent="Kan ikke åbne kamera";
    return false;
  }

  video = document.createElement("video");
  video.setAttribute("playsinline","true");
  video.srcObject = stream;
  await video.play();

  cameraWrap.innerHTML="";
  cameraWrap.appendChild(video);

  canvas=document.createElement("canvas");
  ctx=canvas.getContext("2d");
  return true;
}

function stopCamera(){
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
    stream=null;
  }
  cameraWrap.textContent="Kamera er slukket";
}

/* SCANNING */
async function scanLoop(){
  if(!video || video.readyState !== video.HAVE_ENOUGH_DATA){
    requestAnimationFrame(scanLoop);
    return;
  }
  canvas.width=video.videoWidth;
  canvas.height=video.videoHeight;
  ctx.drawImage(video,0,0);

  let img=ctx.getImageData(0,0,canvas.width,canvas.height);

  if(window.jsQR){
    let code = jsQR(img.data,img.width,img.height);
    if(code){
      stopCamera();
      scanning=false;
      setRawData(code.data);
      newBtn.style.display="inline-flex";
      startBtn.style.display="inline-flex";
      return;
    }
  }
  requestAnimationFrame(scanLoop);
}

/* BUTTONS */
startBtn.onclick=async()=>{
  rawLines.innerHTML="";
  hazardIcon.style.display="none";
  copyBtn.disabled=true;
  copyBtn.classList.add("disabled");

  newBtn.style.display="none";
  startBtn.style.display="none";

  await loadQR();
  scanning=true;
  if(await startCamera()) scanLoop();
};

newBtn.onclick=()=>startBtn.onclick();

/* LOAD jsQR */
function loadQR(){
  return new Promise(res=>{
    if(window.jsQR) return res();
    let s=document.createElement("script");
    s.src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js";
    s.onload=res;
    document.head.appendChild(s);
  });
}
</script>
</body>
</html>
