<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Info Scan — v7.1</title>

<style>
  :root{
    --rw-red: #D20014;
    --text: #111827;
    --muted: #6b7280;
    --line: #000;

    --green: #059669;
    --yellow: #CA8A04;
    --red: #B91C1C;
  }

  body{
    margin:0;
    background:var(--rw-red);
    font-family: Arial, monospace;
    color:var(--text);
  }

  /* TOP BAR --------------------------------------------------- */
  .top{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:16px 18px 10px;
    background:var(--rw-red);
    color:#fff;
  }

  .top-title{
    font-size:20px;
    font-weight:700;
    line-height:1;
  }

  .logo{
    height:38px;
    object-fit:contain;
  }

  /* LAYOUT ---------------------------------------------------- */
  .page{
    padding:16px;
  }

  .card{
    background:white;
    border-radius:14px;
    padding:18px;
    margin-bottom:16px;
  }

  /* CAMERA ---------------------------------------------------- */
  #cameraWrap{
    background:#f3f4f6;
    height:260px;
    border-radius:12px;
    display:flex;
    justify-content:center;
    align-items:center;
    color:#9ca3af;
    overflow:hidden;
  }

  #cameraWrap video{
    width:100%;
    height:100%;
    object-fit:cover;
  }

  /* BUTTON ---------------------------------------------------- */
  .btn{
    width:100%;
    height:56px;
    background:#111827;
    color:white;
    font-size:20px;
    font-weight:700;
    border-radius:12px;
    border:none;
    margin-top:16px;
    cursor:pointer;
  }

  /* RAW DATA -------------------------------------------------- */
  .raw-title{
    font-size:22px;
    font-weight:700;
    margin-bottom:12px;
  }

  .cat{
    font-size:20px;
    font-weight:700;
    margin-top:10px;
  }

  .line{
    border-bottom:2px solid #000;
    margin:6px 0 10px;
  }

  .value{
    font-size:18px;
    white-space:pre-line;
  }

  .w-green{ color:var(--green); font-weight:700; }
  .w-yellow{ color:var(--yellow); font-weight:700; }
  .w-red{ color:var(--red); font-weight:700; }

  #hazardIcon{
    width:42px;
    position:absolute;
    right:12px;
    bottom:12px;
    display:none;
  }

  #copyBtn{
    width:100%;
    height:50px;
    margin-top:16px;
    border-radius:12px;
    border:2px solid #ddd;
    background:white;
    font-size:20px;
    font-weight:700;
    cursor:pointer;
  }
</style>
</head>

<body>

<!-- TOP BAR -->
<div class="top">
  <div class="top-title">Info Scan — v7.1</div>
  <img src="logo.png" class="logo" alt="ROCKWOOL logo">
</div>

<div class="page">

  <!-- SCANNER -->
  <div class="card">
    <div id="cameraWrap">Kamera er slukket</div>
    <button class="btn" id="scanBtn">NY SCANNING</button>
  </div>

  <!-- RAW DATA -->
  <div class="card" style="position:relative;">
    <div class="raw-title">Rådata</div>

    <div id="raw"></div>

    <!-- Hazard icon -->
    <svg id="hazardIcon" viewBox="0 0 400 400">
      <polygon points="200,20 380,200 200,380 20,200"
        fill="white" stroke="#d32f2f" stroke-width="35"/>
      <circle cx="200" cy="270" r="35" fill="black"/>
      <rect x="182" y="90" width="36" height="140" rx="18" fill="black"/>
    </svg>

    <button id="copyBtn">KOPIER</button>
  </div>

</div>

<script>
/* CAMERA + SCANNING ---------------------------------------- */
let stream=null, video=null, canvas=null, ctx=null;

const scanBtn = document.getElementById("scanBtn");
const rawBox = document.getElementById("raw");
const hazardIcon = document.getElementById("hazardIcon");

/* HELPERS --------------------------------------------------- */
function esc(s){ return s.replace(/[&<>]/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[m])) }

function clearRaw(){
  rawBox.innerHTML="";
  hazardIcon.style.display="none";
}

function drawLine(cat, value, cls=""){
  rawBox.insertAdjacentHTML("beforeend", `
    <div class="cat">${cat}</div>
    <div class="line"></div>
    <div class="value ${cls}">${value}</div>
  `);
}

function parseData(raw){
  clearRaw();

  const lines = raw.split(/\r?\n/).filter(l=>l.trim()!=="");
  let data = {};
  let andenInfo = [];

  let inAndenInfo = false;

  lines.forEach(line => {
    if(/^Anden info/i.test(line)){
      inAndenInfo=true;
      const p = line.split(":");
      if(p[1]) andenInfo.push(p[1].trim());
      return;
    }
    if(inAndenInfo){
      andenInfo.push(line.trim());
      return;
    }
    const p=line.split(":");
    if(p.length>=2){
      data[p[0].trim()] = p.slice(1).join(":").trim();
    }
  });

  if(andenInfo.length>0){
    data["Anden info"] = andenInfo.join("\n");
  }

  if(/UN\d+/i.test(raw)){
    hazardIcon.style.display="block";
  }

  const order=[
    "Område","Varenummer","Materiale","Antal",
    "L","B","T","Vægt","Meter","Areal m²",
    "Anden info","Lager/Område","Reol","Hylde","Plads","Kemi"
  ];

  order.forEach(key=>{
    if(!(key in data)) return;

    let value = data[key];
    let cls = "";

    if(key==="Vægt"){
      let kg=parseFloat(value.replace(",",".")) || 0;
      if(kg<=15){ cls="w-green"; value=`${kg} kg`; }
      else if(kg<=30){ cls="w-yellow"; value=`${kg} kg (Pas på når du løfter)`; }
      else{ cls="w-red"; value=`${kg} kg (Brug hjælpe værktøj til løft)`; }
    }

    drawLine(key, esc(value), cls);
  });
}

/* COPY BUTTON ---------------------------------------------- */
document.getElementById("copyBtn").onclick = ()=>{
  navigator.clipboard.writeText(rawBox.innerText);
  copyBtn.textContent="KOPIERET";
  setTimeout(()=>copyBtn.textContent="KOPIER",800);
};

/* CAMERA ---------------------------------------------------- */
async function startCamera(){
  if(!video){
    video=document.createElement("video");
    video.setAttribute("playsinline",true);
  }
  if(!canvas){
    canvas=document.createElement("canvas");
    ctx=canvas.getContext("2d");
  }

  try{
    stream=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:"environment"},
      audio:false
    });
  }catch(e){
    parseData("Demo\nVægt: 20\nKemi: UN1209\nAnden info: Testlinie");
    return;
  }

  video.srcObject=stream;
  await video.play();

  const wrap=document.getElementById("cameraWrap");
  wrap.innerHTML="";
  wrap.appendChild(video);

  scanLoop();
}

function stopCamera(){
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
  }
}

async function scanLoop(){
  if(video.readyState < 2){ requestAnimationFrame(scanLoop); return; }

  canvas.width=video.videoWidth;
  canvas.height=video.videoHeight;
  ctx.drawImage(video,0,0);

  const img=ctx.getImageData(0,0,canvas.width,canvas.height);
  if(window.jsQR){
    const code=jsQR(img.data,img.width,img.height);
    if(code){
      stopCamera();
      parseData(code.data);
      scanBtn.textContent="NY SCANNING";
      return;
    }
  }

  requestAnimationFrame(scanLoop);
}

/* SCAN BUTTON ---------------------------------------------- */
scanBtn.onclick = async ()=>{
  clearRaw();
  scanBtn.textContent="SCANNER…";
  await loadJSQR();
  startCamera();
};

/* LOAD jsQR -------------------------------------------------- */
function loadJSQR(){
  return new Promise(res=>{
    if(window.jsQR) return res();
    let s=document.createElement("script");
    s.src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js";
    s.onload=res;
    document.body.appendChild(s);
  });
}
</script>

</body>
</html>

