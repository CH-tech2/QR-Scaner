<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Info Scan — v8.6</title>
<style>
  :root{
    --rw-red:#D20014;
    --text:#111827;
    --black:#000;
    --un:#b91c1c;
    --green:#059669;
    --yellow:#CA8A04;
    --red:#B91C1C;
  }

  /* page */
  body{
    margin:0;
    padding:12px;
    font-family: Arial, ui-monospace, monospace;
    background:var(--rw-red);
    color:var(--text);
  }

  /* topbar: title left, logo right */
  .topbar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
    margin-bottom:10px;
  }
  .topTitle{
    color:#fff;
    font-weight:900;
    font-size:20px;
  }
  .logo{
    height:70px; /* A-size */
    width:auto;
    display:block;
  }

  .card{
    background:#fff;
    border-radius:12px;
    padding:14px;
    margin-bottom:14px;
  }

  #cameraWrap{
    height:260px;
    border-radius:10px;
    background:#f3f4f6;
    display:flex;
    align-items:center;
    justify-content:center;
    color:#9ca3af;
    overflow:hidden;
  }
  /* ensure no accidental iOS mirror and visual layout preserved */
  #cameraWrap video{
    width:100%;
    height:100%;
    object-fit:cover; /* important to preserve iPhone behavior & design */
    transform:none !important;
    -webkit-transform:none !important;
  }

  .btn{
    width:100%;
    height:56px;
    margin-top:14px;
    border-radius:10px;
    border:0;
    background:#0f172a;
    color:#fff;
    font-weight:900;
    font-size:18px;
    cursor:pointer;
  }

  .box{
    border:2px solid var(--black);
    border-radius:6px;
    padding:10px 12px;
    margin-bottom:12px;
    background:white;
  }

  .catTitle{
    font-size:17px;
    font-weight:900;
    margin-bottom:8px;
  }

  .boxValue{
    font-family: ui-monospace, monospace;
    font-size:16px;
    white-space:pre-wrap;
  }

  .w-green{ color:var(--green); font-weight:900; }
  .w-yellow{ color:var(--yellow); font-weight:900; }
  .w-red{ color:var(--red); font-weight:900; }

  .kemiRow{
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .hazard{
    width:34px;
    height:34px;
  }

  #copyBtn{
    width:100%;
    height:50px;
    margin-top:12px;
    border-radius:10px;
    border:2px solid #ddd;
    background:white;
    font-weight:900;
    font-size:16px;
    cursor:pointer;
  }

  @media (max-width:700px){
    .logo{ height:56px; }
    .topTitle{ font-size:18px; }
  }
</style>
</head>
<body>

<div class="topbar">
  <div class="topTitle">Info Scan — v8.6</div>
  <img class="logo" src="logo.png" alt="ROCKWOOL logo" onerror="this.style.display='none'"/>
</div>

<!-- Scanner card -->
<div class="card">
  <div style="font-weight:700;margin-bottom:8px;">Scanner</div>
  <div id="cameraWrap">Kamera er slukket</div>
  <button id="scanBtn" class="btn">NY SCANNING</button>
</div>

<!-- Raw data -->
<div class="card" style="position:relative;">
  <div style="font-weight:700;margin-bottom:10px;font-size:18px;">Rådata</div>
  <div id="output"></div>
  <button id="copyBtn" disabled>KOPIER</button>
</div>

<script>
/* Info Scan v8.6
   - Beholder layout/design fra v7.9
   - Kamera-fix: scanne fra rå stream for Android + iPhone kompatibilitet
   - Fjerner første linje i Lagerplads-udskrivning
   - Indlæser jsQR dynamisk
*/

/* Elements */
const scanBtn = document.getElementById('scanBtn');
const output  = document.getElementById('output');
const copyBtn = document.getElementById('copyBtn');
const cameraWrap = document.getElementById('cameraWrap');

let videoEl = null;
let canvas = null;
let ctx = null;
let stream = null;
let raf = null;

/* Utility */
function esc(s){ return String(s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }
function classifyWeight(kg){
  if(kg <= 15) return {cls:'w-green', extra:''};
  if(kg <= 30) return {cls:'w-yellow', extra:' (Pas på når du løfter)'};
  return {cls:'w-red', extra:' (Brug hjælpe værktøj til løft)'};
}
function enableCopy(enable){ copyBtn.disabled = !enable; }

/* Clear output */
function clearOutput(){
  output.innerHTML = '';
  enableCopy(false);
}

/* parser (same stable logic as v7.7) */
function parseRaw(raw){
  const lines = String(raw||"").split(/\r?\n/).map(l=>l.trim()).filter(l=>l);
  const data = {};
  let collecting=false;
  let andenArr=[];

  const known = ['Område','Varenummer','Materiale','Antal','Længde','Bredde','Tykkelse','Vægt',
                 'Areal i m²','Anden info','Lagerplads','Lager/Område','Reol','Hylde','Plads','Kemi','Meter'];

  for(let i=0;i<lines.length;i++){
    const line = lines[i];

    if(/^Anden info/i.test(line)){
      collecting = true;
      const parts=line.split(':');
      if(parts.length>1) andenArr.push(parts.slice(1).join(':').trim());
      continue;
    }

    if(collecting){
      if(/^[A-Za-z].*?:/.test(line)){
        const maybeKey = line.split(':')[0].trim();
        if(known.includes(maybeKey)){
          collecting = false;
          i--; // reprocess this line as a key
          continue;
        }
      }
      andenArr.push(line);
      continue;
    }

    if(line.includes(':')){
      const parts=line.split(':');
      data[parts[0].trim()] = parts.slice(1).join(':').trim();
    } else {
      // append to last key if exists
      const lastKey = Object.keys(data).slice(-1)[0];
      if(lastKey){
        data[lastKey] = (data[lastKey] + '\n' + line).trim();
      } else {
        data['_extra'] = (data['_extra'] ? data['_extra'] + '\n' : '') + line;
      }
    }
  }
  if(andenArr.length) data['Anden info'] = andenArr.join('\n');
  return data;
}

/* rendering identical to previous stable but with Lagerplads first-line removed */
function makeBox(title, valueHtml){
  const d = document.createElement('div');
  d.className = 'box';
  d.innerHTML = `<div class="catTitle">${esc(title)}</div><div class="boxValue">${valueHtml}</div>`;
  return d;
}
function makeKemiBox(title, valueHtml, showHazard){
  const d = document.createElement('div');
  d.className = 'box';
  d.innerHTML = `<div class="catTitle">${esc(title)}</div>
    <div class="kemiRow">
      <div class="boxValue">${valueHtml}</div>
      ${showHazard? `<svg class="hazard" viewBox="0 0 400 400">
        <polygon points="200,20 380,200 200,380 20,200" fill="white" stroke="#d32f2f" stroke-width="35"/>
        <circle cx="200" cy="270" r="35" fill="black"/>
        <rect x="182" y="90" width="36" height="140" rx="18" fill="black"/>
      </svg>` : ''}
    </div>`;
  return d;
}

function renderData(data){
  clearOutput();
  const boxes = [
    {title:'Område', keys:['Område']},
    {title:'Varenummer', keys:['Varenummer']},
    {title:'Materiale', keys:['Materiale']},
    {title:'Antal', keys:['Antal']},
    {title:'Mål', keys:['Længde','Bredde','Tykkelse']},
    {title:'Vægt', keys:['Vægt']},
    {title:'Areal i m²', keys:['Areal i m²']},
    {title:'Anden info', keys:['Anden info']},
    {title:'Lagerplads', keys:['Lagerplads','Lager/Område','Reol','Hylde','Plads']},
    {title:'Kemi', keys:['Kemi']}
  ];

  let unFound = false;
  Object.values(data).forEach(v => { if(/\bUN\d+/.test(v)) unFound = true; });

  boxes.forEach(box => {
    const present = box.keys.filter(k => (k in data) && String(data[k]).trim() !== '');
    if(!present.length) return;

    if(box.title === 'Mål'){
      const arr = [];
      ['Længde','Bredde','Tykkelse'].forEach(k => { if(k in data) arr.push(`${k}: ${esc(data[k])}`); });
      output.appendChild(makeBox(box.title, arr.join('\n')));
      return;
    }

    if(box.title === 'Vægt'){
      const raw = data['Vægt'] ? String(data['Vægt']).trim() : '';
      const m = raw.match(/([\d\.,]+)/);
      let kg = null;
      if(m) kg = parseFloat(m[1].replace(',','.'));
      let cls = '', txt = esc(raw);
      if(kg !== null && !isNaN(kg)){
        const inf = classifyWeight(kg);
        cls = inf.cls;
        txt = `${kg} kg${inf.extra}`;
      }
      output.appendChild(makeBox(box.title, `<span class="${cls}">${txt}</span>`));
      return;
    }

    if(box.title === 'Anden info'){
      output.appendChild(makeBox(box.title, esc(data['Anden info'] || '')));
      return;
    }

    if(box.title === 'Lagerplads'){
      // Show values only (without repeating the key as first line)
      const arr = [];
      ['Lagerplads','Lager/Område','Reol','Hylde','Plads'].forEach(k => { if(k in data) arr.push(esc(data[k])); });
      output.appendChild(makeBox(box.title, arr.join('\n')));
      return;
    }

    if(box.title === 'Kemi'){
      const v = esc(data['Kemi'] || '');
      output.appendChild(makeKemiBox('Kemi', v, unFound || /\bUN\d+/.test(v)));
      return;
    }

    // default single field
    const key = present[0];
    output.appendChild(makeBox(box.title, esc(data[key])));
  });

  enableCopy(true);
}

/* COPY */
copyBtn.addEventListener('click', async () => {
  try{
    await navigator.clipboard.writeText(output.innerText || '');
    const prev = copyBtn.textContent;
    copyBtn.textContent = 'KOPIERET';
    setTimeout(()=>copyBtn.textContent = prev,700);
  }catch(e){}
});

/* --- JSQR loader --- */
function loadJsQR(){
  return new Promise(res=>{
    if(window.jsQR) return res();
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js';
    s.onload = res;
    s.onerror = res; // resolve anyway; fallback handled
    document.head.appendChild(s);
  });
}

/* --- CAMERA IMPROVEMENTS FOR ANDROID + IPHONE --- */
async function startCamera(){
  clearOutput();

  if(!videoEl){
    videoEl = document.createElement('video');
    videoEl.setAttribute('playsinline','true');
  }
  if(!canvas){
    canvas = document.createElement('canvas');
    // willReadFrequently helps browsers optimize readPixels
    ctx = canvas.getContext('2d', { willReadFrequently: true });
  }

  // flexible constraints to maximize compatibility
  const constraints = {
    video: {
      facingMode: { ideal: "environment" },
      width: { min:640, ideal:1280, max:1920 },
      height: { min:480, ideal:720, max:1080 }
    },
    audio: false
  };

  try{
    stream = await navigator.mediaDevices.getUserMedia(constraints);

    // try to set continuous focus but DO NOT force zoom
    try{
      const track = stream.getVideoTracks()[0];
      const caps = track.getCapabilities ? track.getCapabilities() : {};
      const adv = [];

      if(caps.focusMode && caps.focusMode.includes('continuous')){
        adv.push({ focusMode: 'continuous' });
      }
      // intentionally do NOT set zoom here
      if(adv.length) track.applyConstraints({ advanced: adv }).catch(()=>{ /* ignore */ });
    }catch(e){ /* ignore capability errors */ }

    videoEl.srcObject = stream;
    await videoEl.play();

    cameraWrap.innerHTML = '';
    cameraWrap.appendChild(videoEl);

    return true;
  }catch(err){
    console.warn('Camera start failed:', err);
    return false;
  }
}

function stopCamera(){
  if(raf) cancelAnimationFrame(raf);
  raf = null;
  if(stream){
    stream.getTracks().forEach(t => t.stop());
    stream = null;
  }
  if(videoEl){
    try{ videoEl.pause(); }catch(e){}
    videoEl.srcObject = null;
  }
  cameraWrap.innerHTML = 'Kamera er slukket';
}

/* Optimized scanLoop that reads from the raw camera resolution (fixes Android cropping issue) */
async function scanLoop(){
  if(!videoEl || videoEl.readyState !== videoEl.HAVE_ENOUGH_DATA){
    raf = requestAnimationFrame(scanLoop);
    return;
  }

  // Determine raw capture size — prefer track settings, fall back to video dims
  let capW = (stream && stream.getVideoTracks && stream.getVideoTracks()[0] && stream.getVideoTracks()[0].getSettings && stream.getVideoTracks()[0].getSettings().width) || videoEl.videoWidth || 1280;
  let capH = (stream && stream.getVideoTracks && stream.getVideoTracks()[0] && stream.getVideoTracks()[0].getSettings && stream.getVideoTracks()[0].getSettings().height) || videoEl.videoHeight || 720;

  // ensure canvas matches capture size
  if(canvas.width !== capW || canvas.height !== capH){
    canvas.width = capW;
    canvas.height = capH;
  }

  try{
    // draw full raw frame (not the CSS-cropped presentation)
    ctx.drawImage(videoEl, 0, 0, capW, capH);
  }catch(e){
    // fallback to drawing with video dimensions
    ctx.drawImage(videoEl, 0, 0, canvas.width, canvas.height);
  }

  // read pixels
  let img;
  try{
    img = ctx.getImageData(0,0,canvas.width,canvas.height);
  }catch(e){
    // some browsers restrict getImageData while video is playing; skip frame
    raf = requestAnimationFrame(scanLoop);
    return;
  }

  let code = null;
  if(window.jsQR){
    try{
      code = jsQR(img.data, img.width, img.height, { inversionAttempts: 'attemptBoth' });
    }catch(e){
      code = jsQR(img.data, img.width, img.height);
    }
  }

  if(code && code.data){
    stopCamera();
    const parsed = parseRaw(code.data);
    renderData(parsed);
    return;
  }

  // continue scanning as fast as possible
  raf = requestAnimationFrame(scanLoop);
}

/* --- BUTTON HANDLER --- */
scanBtn.addEventListener('click', async () => {
  // clear previous data immediately (user wanted this)
  clearOutput();
  cameraWrap.innerHTML = 'Starter kamera…';

  await loadJsQR(); // load library if not present
  const ok = await startCamera();

  if(!ok){
    // fallback demo if camera unavailable (still clears)
    const demo = `Område: Demo
Varenummer: 12345
Materiale: DemoMat
Antal: 2 KS
Længde: 1000
Bredde: 600
Tykkelse: 10
Vægt: 18
Areal i m²: 2
Anden info: Test linje1
Test linje2
Lager/Område: sym01
Reol: 01
Hylde: 02
Plads: 03
Kemi: UN1209`;
    renderData(parseRaw(demo));
    return;
  }

  // begin scanning loop
  scanLoop();
});

/* cleanup on page unload */
window.addEventListener('beforeunload', stopCamera);

/* make copy button safe even if not supported */
copyBtn.addEventListener('click', async ()=>{
  try{
    await navigator.clipboard.writeText(output.innerText || '');
    const prev = copyBtn.textContent;
    copyBtn.textContent = 'KOPIERET';
    setTimeout(()=>copyBtn.textContent = prev,700);
  }catch(e){}
});
</script>
</body>
</html>
