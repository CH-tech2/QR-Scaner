<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Info Scan v6.7</title>

<style>
  :root{
    --bg: #D20014; /* ROCKWOOL RØD */
    --text: #111827;
    --muted: #6b7280;
    --un-color: #b91c1c;

    --weight-green: #059669;
    --weight-yellow: #CA8A04;
    --weight-red: #B91C1C;
  }

  body{
    background: var(--bg);
    color: var(--text);
    font-family: Arial, monospace;
    margin: 0;
    padding: 0 16px 40px;
  }

  /* TOPBAR -------------------------------------------------- */
  #topbar{
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 18px 0 8px;
    color: #fff;
  }

  #topTitle{
    font-size: 20px;
    font-weight: 700;
    line-height: 1.1;
  }

  #topLogo{
    height: 46px;       /* perfekt til at stå på linje med titlen */
    width: auto;
    object-fit: contain;
  }

  /* LAYOUT -------------------------------------------------- */
  .card{
    background:#fff;
    border-radius:12px;
    padding:16px;
    margin-top:18px;
  }

  #cameraWrap{
    background:#f3f4f6;
    border-radius:8px;
    height:260px;
    display:flex;
    align-items:center;
    justify-content:center;
    color:#9ca3af;
    overflow:hidden;
  }

  #cameraWrap video{
    width:100%;
    height:100%;
    object-fit:cover;
    transform:none !important;
    -webkit-transform:none !important;
  }

  /* RAW DATA STYLING ---------------------------------------- */
  .section-title{
    font-weight:700;
    margin-top: 14px;
    margin-bottom:4px;
    font-size:16px;
  }

  .raw-line{
    padding:8px 4px;
    border-bottom:2px solid #000;
    font-family: ui-monospace, monospace;
    font-size: 16px;
    white-space:pre-wrap;
  }

  .un{ color: var(--un-color); font-weight:700; }

  .weight-green{ color: var(--weight-green); font-weight:700; }
  .weight-yellow{ color: var(--weight-yellow); font-weight:700; }
  .weight-red{ color: var(--weight-red); font-weight:700; }

  /* Hazard icon */
  #hazardIcon{
    position:absolute;
    bottom:6px;
    right:6px;
    width:38px;
    height:38px;
    display:none;
    pointer-events:none;
    z-index:50;
  }

  /* Buttons -------------------------------------------------- */
  .btn{
    width:100%;
    height:56px;
    border:0;
    border-radius:10px;
    background:#0f172a;
    color:#fff;
    font-size:20px;
    font-weight:700;
    margin-top:12px;
    cursor:pointer;
  }
  .btn:disabled{ opacity:0.45; }

</style>
</head>

<body>

<!-- TOP BAR -->
<div id="topbar">
  <div id="topTitle">Info Scan — v6.7</div>
  <img id="topLogo" src="logo.png" alt="Rockwool Logo" />
</div>

<!-- SCANNER -->
<div class="card">
  <strong style="font-size:18px;">Scanner</strong>

  <div id="cameraWrap">Kamera er slukket</div>

  <button class="btn" id="scanBtn">NY SCANNING</button>
</div>

<!-- RAW DATA -->
<div class="card" style="position:relative;">
  <strong style="font-size:18px;">Rådata</strong>

  <div id="rawBox" style="margin-top:10px; position:relative;">
    <div id="rawLines"></div>

    <!-- hazard symbol -->
    <svg id="hazardIcon" viewBox="0 0 400 400">
      <polygon points="200,20 380,200 200,380 20,200"
        fill="white" stroke="#d32f2f" stroke-width="35"/>
      <circle cx="200" cy="270" r="35" fill="black"/>
      <rect x="182" y="90" width="36" height="140" rx="18" fill="black"/>
    </svg>
  </div>

  <button class="btn" id="copyBtn" disabled>KOPIER</button>
</div>

<script>
/* CORE SCAN LOGIC ----------------------------------------- */

let stream=null, videoEl=null, canvas=null, ctx=null, scanning=false, rafId=null;

const scanBtn = document.getElementById("scanBtn");
const copyBtn = document.getElementById("copyBtn");
const rawLines = document.getElementById("rawLines");
const hazardIcon = document.getElementById("hazardIcon");
const cameraWrap = document.getElementById("cameraWrap");

function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;',
    '"':'&quot;',"'":'&#39;'
  }[m]));
}

function normalizeRawText(raw){
  return String(raw||"")
    .split(/\r?\n/)
    .map(l=>l.trim())
    .filter(l=>l!=="")
    .join("\n");
}

function highlightUN(txt){
  return txt.replace(/\b(UN\d+(?:,\d+)*)\b/g,'<span class="un">$1</span>');
}

function classifyWeight(kg){
  if(kg<=15) return {cls:"weight-green", extra:""};
  if(kg<=30) return {cls:"weight-yellow", extra:" (Pas på når du løfter)"};
  return {cls:"weight-red", extra:" (Brug hjælpe værktøj til løft)"};
}

function extractWeight(line){
  const m = line.match(/Vægt:\s*([\d.,]+)/i);
  if(!m) return null;
  return parseFloat(m[1].replace(",",".")) || null;
}

/* Render raw data with groups -------------------------------------- */
function setRawData(raw){
  rawLines.innerHTML = "";
  hazardIcon.style.display = "none";

  const clean = normalizeRawText(raw);
  if(!clean){ copyBtn.disabled=true; return; }

  const lines = clean.split(/\r?\n/);

  let currentSection = "";
  const sectionTitles = ["Område","Varenummer","Materiale","Antal","Mål","Lagerplads","Kemi"];

  if(/\bUN\d+/.test(clean)) hazardIcon.style.display="block";

  lines.forEach(line=>{
    let titleMatch = sectionTitles.find(t => line.startsWith(t+":"));
    if(titleMatch){
      currentSection = titleMatch;
      rawLines.insertAdjacentHTML("beforeend",
        `<div class="section-title">${escapeHtml(titleMatch)}</div>`
      );
    }

    let html = escapeHtml(line);
    html = highlightUN(html);

    if(line.startsWith("Vægt:")){
      const kg = extractWeight(line);
      if(kg!==null){
        const w = classifyWeight(kg);
        html = html.replace(/$/, escapeHtml(w.extra));
        rawLines.insertAdjacentHTML("beforeend",
          `<div class="raw-line ${w.cls}">${html}</div>`
        );
        return;
      }
    }

    rawLines.insertAdjacentHTML("beforeend",
      `<div class="raw-line">${html}</div>`
    );
  });

  copyBtn.disabled=false;
}

/* Copy button */
copyBtn.addEventListener("click", async ()=>{
  await navigator.clipboard.writeText(rawLines.innerText);
  copyBtn.innerText="KOPIERET";
  setTimeout(()=>copyBtn.innerText="KOPIER",800);
});

/* jsQR loader */
function loadJsQr(){
  return new Promise((res,rej)=>{
    if(window.jsQR) return res(window.jsQR);
    const s=document.createElement("script");
    s.src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js";
    s.onload=()=>res(window.jsQR);
    s.onerror=rej;
    document.head.appendChild(s);
  });
}

/* Camera start */
async function startCamera(){
  if(!videoEl){
    videoEl=document.createElement("video");
    videoEl.setAttribute("playsinline","true");
  }
  if(!canvas){
    canvas=document.createElement("canvas");
    ctx=canvas.getContext("2d");
  }

  try{
    stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:{ideal:"environment"} }, audio:false
    });

    videoEl.srcObject=stream;
    await videoEl.play();

    cameraWrap.innerHTML="";
    cameraWrap.appendChild(videoEl);

    return true;
  }catch(e){
    return false;
  }
}

function stopCamera(){
  if(rafId){ cancelAnimationFrame(rafId); rafId=null; }
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
    stream=null;
  }
  if(videoEl){
    videoEl.pause();
    videoEl.srcObject=null;
  }
  cameraWrap.innerHTML="Kamera er slukket";
}

async function scanLoop(){
  if(!videoEl || videoEl.readyState!==videoEl.HAVE_ENOUGH_DATA){
    rafId=requestAnimationFrame(scanLoop);
    return;
  }

  if(canvas.width!==videoEl.videoWidth){
    canvas.width=videoEl.videoWidth;
    canvas.height=videoEl.videoHeight;
  }

  ctx.drawImage(videoEl,0,0,canvas.width,canvas.height);
  const img = ctx.getImageData(0,0,canvas.width,canvas.height);
  const code = window.jsQR && jsQR(img.data,img.width,img.height);

  if(code && code.data){
    stopCamera();
    setRawData(code.data);
    scanning=false;
    return;
  }

  rafId=requestAnimationFrame(scanLoop);
}

/* Button: NY SCANNING */
scanBtn.addEventListener("click", async ()=>{
  rawLines.innerHTML="";
  hazardIcon.style.display="none";
  copyBtn.disabled=true;

  scanning=true;

  await loadJsQr();
  const ok = await startCamera();

  if(!ok){
    setRawData("Demo\nVægt: 12 kg\nKemi: UN1209");
    scanning=false;
    return;
  }

  scanLoop();
});

/* stop camera on close */
window.addEventListener("beforeunload", stopCamera);

</script>
</body>
</html>
