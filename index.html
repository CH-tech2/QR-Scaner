<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Info Scan v4.7</title>

<style>
  :root{
    --bg: #D20014;
    --text:#111827;
    --muted:#6b7280;
    --un-color:#b91c1c;
    --weight-green:#059669;
    --weight-yellow:#CA8A04;
    --weight-red:#B91C1C;
  }

  body{
    background:var(--bg);
    margin:16px;
    font-family:Arial, monospace;
  }

  /* HEADER */
  .header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:14px;
  }

  .header-title{
    font-size:20px;
    font-weight:700;
    color:white;
    margin:0;
  }

  .logo-box{
    background:white;
    padding:6px 12px;
    border-radius:10px;
    display:flex;
    align-items:center;
  }

  .rw-logo{
    height:34px;
    display:block;
  }

  /* LAYOUT */
  .container{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:20px;
  }

  .card{
    background:white;
    border-radius:10px;
    padding:16px;
    border:1px solid #e5e7eb;
  }

  #cameraWrap{
    height:260px;
    background:#f3f4f6;
    border-radius:8px;
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
    color:#9ca3af;
  }

  #cameraWrap video{
    width:100%;
    height:100%;
    object-fit:cover;
    transform:none !important;
    -webkit-transform:none !important;
  }

  .raw-box{
    background:white;
    border-radius:8px;
    border:1px solid #e5e7eb;
    position:relative;
    overflow:auto;
  }

  .qr-lines div{
    padding:8px 10px;
    border-bottom:2px solid black;
    white-space:pre-wrap;
    font-family:ui-monospace, monospace;
  }

  .un{ color:#b91c1c; font-weight:700; }

  .weight-green{ color:#059669; font-weight:700; }
  .weight-yellow{ color:#CA8A04; font-weight:700; }
  .weight-red{ color:#B91C1C; font-weight:700; }

  #hazardIcon{
    position:absolute;
    bottom:6px;
    right:6px;
    width:38px;
    height:38px;
    display:none;
  }

  .btn-row{
    display:flex;
    gap:10px;
    margin-top:12px;
  }

  .btn{
    width:140px;
    height:48px;
    border-radius:8px;
    border:none;
    cursor:pointer;
    font-weight:700;
    font-size:16px;
    background:#111827;
    color:white;
  }

  .btn.ghost{
    background:white;
    color:#111827;
    border:1px solid #d1d5db;
  }

  .btn:disabled{ opacity:.45; }

  @media(max-width:900px){
    .container{ grid-template-columns:1fr; }
  }
</style>
</head>

<body>

<!-- HEADER -->
<div class="header">
  <h1 class="header-title">Info Scan — v4.7</h1>

  <!-- Official ROCKWOOL logo SVG -->
  <div class="logo-box">
    <svg class="rw-logo" viewBox="0 0 900 220" xmlns="http://www.w3.org/2000/svg">

      <!-- WHITE TEXT -->
      <text x="250" y="150" font-family="Arial Black, Arial" font-size="130" fill="#FFFFFF">
        ROCKWOOL
      </text>

      <!-- RED ICON BOX -->
      <rect x="0" y="0" width="220" height="220" fill="#FFFFFF"/>
      <rect x="10" y="10" width="200" height="200" fill="#D20014"/>

      <!-- ICON SHAPE -->
      <path d="M75 150 L110 60 L145 150 Z" fill="white"/>
      <path d="M55 70 L75 70 L65 150 L55 150 Z" fill="white"/>
    </svg>
  </div>
</div>

<!-- MAIN -->
<div class="container">

  <!-- SCANNER -->
  <div class="card">
    <strong>Scanner</strong>
    <div id="cameraWrap">Kamera er slukket</div>

    <div class="btn-row">
      <button class="btn" id="startBtn">START SCANNING</button>
      <button class="btn ghost" id="newBtn" style="display:none;">NY SCANNING</button>
    </div>
  </div>

  <!-- RAW DATA -->
  <div class="card">
    <strong>Rådata</strong>

    <div class="raw-box" style="margin-top:10px;">
      <div id="rawLines" class="qr-lines"></div>

      <!-- HAZARD ICON -->
      <svg id="hazardIcon" viewBox="0 0 400 400">
        <polygon points="200,20 380,200 200,380 20,200"
        fill="white" stroke="#d32f2f" stroke-width="35"/>
        <circle cx="200" cy="270" r="35" fill="black"/>
        <rect x="182" y="90" width="36" height="140" rx="18" fill="black"/>
      </svg>
    </div>

    <div class="btn-row">
      <button class="btn ghost" id="copyBtn" disabled>KOPIER</button>
    </div>
  </div>

</div>

<script>
/* --- Info Scan v4.7 engine (identisk med din stabile version) --- */

const startBtn=document.getElementById("startBtn");
const newBtn=document.getElementById("newBtn");
const copyBtn=document.getElementById("copyBtn");
const cameraWrap=document.getElementById("cameraWrap");
const rawLines=document.getElementById("rawLines");
const hazardIcon=document.getElementById("hazardIcon");

let stream=null, videoEl=null, canvas=null, ctx=null, scanning=false, rafId=null;

function escapeHtml(s){return s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
function normalizeRaw(t){return t.split(/\r?\n/).map(l=>l.trim()).filter(l=>l).join("\n");}
function highlightUN(s){return s.replace(/\b(UN\d+(?:,\d+)*)\b/g,'<span class="un">$1</span>');}

function classifyWeight(kg){
  if(kg<=15) return {cls:"weight-green", extra:""};
  if(kg<=30) return {cls:"weight-yellow", extra:" (Pas på når du løfter)"};
  return {cls:"weight-red", extra:" (Brug hjælpe værktøj til løft)"};
}
function extractWeight(line){
  const m=line.match(/Vægt:\s*([\d.,]+)/i);
  if(!m) return null;
  return parseFloat(m[1].replace(",",".")) || null;
}

function setRawData(raw){
  rawLines.innerHTML="";
  hazardIcon.style.display="none";

  const n=normalizeRaw(raw);
  if(!n){ copyBtn.disabled=true; return; }

  const lines=n.split("\n");

  if(/\bUN\d+/.test(n)) hazardIcon.style.display="block";

  lines.forEach(line=>{
    const div=document.createElement("div");
    let html = highlightUN(escapeHtml(line));

    if(line.startsWith("Vægt")){
      const kg=extractWeight(line);
      if(kg!==null){
        const info=classifyWeight(kg);
        div.classList.add(info.cls);
        html+=info.extra;
      }
    }

    div.innerHTML=html;
    rawLines.appendChild(div);
  });

  copyBtn.disabled=false;
}

/* COPY */
copyBtn.addEventListener("click", async()=>{
  await navigator.clipboard.writeText(rawLines.innerText);
  copyBtn.innerText="KOPIERET";
  setTimeout(()=>copyBtn.innerText="KOPIER",700);
});

/* Load jsQR */
function loadJsQr(){
  return new Promise((res)=>{
    if(window.jsQR) return res();
    const s=document.createElement("script");
    s.src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js";
    s.onload=()=>res();
    document.head.appendChild(s);
  });
}

/* CAMERA */
async function startCamera(){
  if(!videoEl){
    videoEl=document.createElement("video");
    videoEl.setAttribute("playsinline","true");
  }
  if(!canvas){
    canvas=document.createElement("canvas");
    ctx=canvas.getContext("2d");
  }

  try{
    stream=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:{ideal:"environment"}},
      audio:false
    });
    videoEl.srcObject=stream;
    await videoEl.play();
    cameraWrap.innerHTML="";
    cameraWrap.appendChild(videoEl);
    return true;
  }catch{
    return false;
  }
}

function stopCamera(){
  if(rafId) cancelAnimationFrame(rafId);
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
    stream=null;
  }
  if(videoEl){
    videoEl.pause();
    videoEl.srcObject=null;
  }
  cameraWrap.innerHTML="Kamera er slukket";
}

/* SCAN LOOP */
function scanLoop(){
  if(!scanning) return;

  if(videoEl.readyState===videoEl.HAVE_ENOUGH_DATA){
    canvas.width=videoEl.videoWidth;
    canvas.height=videoEl.videoHeight;
    ctx.drawImage(videoEl,0,0);

    const img = ctx.getImageData(0,0,canvas.width,canvas.height);
    const code = window.jsQR ? jsQR(img.data,img.width,img.height) : null;

    if(code){
      scanning=false;
      stopCamera();
      setRawData(code.data);
      startBtn.style.display="inline-flex";
      newBtn.style.display="none";
      return;
    }
  }
  rafId=requestAnimationFrame(scanLoop);
}

/* START */
startBtn.onclick=async()=>{
  scanning=true;
  startBtn.style.display="none";
  newBtn.style.display="inline-flex";

  await loadJsQr();
  const ok=await startCamera();

  if(!ok){
    setTimeout(()=>{ setRawData("Demo\nVægt: 18 kg\nKemi: UN1209"); },400);
    scanning=false;
    return;
  }

  scanLoop();
};

/* NEW */
newBtn.onclick=()=>{
  stopCamera();
  rawLines.innerHTML="";
  hazardIcon.style.display="none";
  copyBtn.disabled=true;
  scanning=true;
  startBtn.onclick();
};

window.addEventListener("beforeunload", stopCamera);
</script>

</body>
</html>
