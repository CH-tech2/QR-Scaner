<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Info Scan — v6.0</title>
<style>
  :root{
    --rw-red: #D20014;
    --text: #111827;
    --muted: #6b7280;
    --un-color:#b91c1c;
    --weight-green:#059669;
    --weight-yellow:#CA8A04;
    --weight-red:#B91C1C;
  }

  /* Page */
  body{
    margin:0;
    padding:18px;
    background:var(--rw-red);
    font-family: Arial, monospace;
    color:var(--text);
  }

  /* Header */
  .topbar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin-bottom:16px;
  }
  .title{ color:#fff; font-size:20px; font-weight:700; margin:0; }

  /* Logo (no white box). If logo.png missing it will hide via onerror) */
  #rwlogo{
    height:36px;
    width:auto;
    display:block;
  }

  /* Layout */
  .container{ display:grid; grid-template-columns:1fr; gap:18px; }

  .card{
    background:#fff;
    border-radius:12px;
    padding:16px;
    box-sizing:border-box;
  }

  /* Camera preview */
  #cameraWrap{
    background:#f3f4f6;
    border-radius:10px;
    height:260px;
    display:flex;
    align-items:center;
    justify-content:center;
    color:#9ca3af;
    overflow:hidden;
  }
  #cameraWrap video{ width:100%; height:100%; object-fit:cover; transform:none !important; -webkit-transform:none !important; }

  /* Raw data */
  .raw-box{ position:relative; border-radius:8px; overflow:auto; }
  .qr-lines div{
    padding:10px;
    border-bottom:2px solid #111;
    font-family: ui-monospace, monospace;
    font-size:15px;
    white-space:pre-wrap;
  }
  .qr-lines .un{ color:var(--un-color); font-weight:700; }

  /* Weight colors */
  .weight-green{ color:var(--weight-green); font-weight:700; }
  .weight-yellow{ color:var(--weight-yellow); font-weight:700; }
  .weight-red{ color:var(--weight-red); font-weight:700; }

  /* Hazard icon */
  #hazardIcon{
    position:absolute;
    bottom:8px;
    right:8px;
    width:40px;
    height:40px;
    display:none;
    pointer-events:none;
  }

  /* Buttons */
  .btn-row{ margin-top:12px; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .btn{
    width:160px;
    height:52px;
    border-radius:10px;
    border:0;
    background:#0d1321;
    color:#fff;
    font-weight:700;
    font-size:16px;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    justify-content:center;
  }
  .btn.ghost{
    background:#fff;
    color:#111;
    border:1px solid #d1d5db;
  }
  .btn:disabled{ opacity:0.45; cursor:not-allowed; }

  @media(max-width:900px){
    body{ padding:12px; }
    #rwlogo{ height:32px; }
    .btn{ width:140px; height:48px; font-size:15px; }
  }
</style>
</head>
<body>

<!-- HEADER -->
<div class="topbar">
  <div class="title">Info Scan — v6.0</div>
  <!-- External file logo: place logo.png in same folder on GitHub. If missing it's hidden. -->
  <img id="rwlogo" src="logo.png" alt="ROCKWOOL logo" onerror="this.style.display='none'">
</div>

<div class="container">
  <!-- Scanner card -->
  <div class="card">
    <strong>Scanner</strong>

    <div id="cameraWrap">Kamera er slukket</div>

    <div class="btn-row">
      <button class="btn" id="startBtn">START SCANNING</button>
      <button class="btn ghost" id="newBtn" style="display:none;">NY SCANNING</button>
      <div id="scanStatus" style="margin-left:8px;color:#444;"></div>
    </div>
  </div>

  <!-- Raw data card -->
  <div class="card">
    <strong>Rådata</strong>

    <div class="raw-box" style="margin-top:10px;">
      <div id="rawLines" class="qr-lines"></div>

      <!-- hazard icon (shows only if UNxxx present) -->
      <svg id="hazardIcon" viewBox="0 0 400 400">
        <polygon points="200,20 380,200 200,380 20,200" fill="white" stroke="#d32f2f" stroke-width="35"/>
        <circle cx="200" cy="270" r="35" fill="black"/>
        <rect x="182" y="90" width="36" height="140" rx="18" fill="black"/>
      </svg>
    </div>

    <div class="btn-row" style="margin-top:12px;">
      <button class="btn ghost" id="copyBtn" disabled>KOPIER</button>
    </div>
  </div>
</div>

<script>
/* Info Scan v6.0 (file-logo version). Full scanning engine, UN highlight, weight colors. */

const startBtn = document.getElementById("startBtn");
const newBtn   = document.getElementById("newBtn");
const copyBtn  = document.getElementById("copyBtn");
const scanStatus = document.getElementById("scanStatus");
const cameraWrap = document.getElementById("cameraWrap");
const rawLines = document.getElementById("rawLines");
const hazardIcon = document.getElementById("hazardIcon");

let stream=null, videoEl=null, canvas=null, ctx=null, scanning=false, rafId=null;

/* helpers */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function normalizeRawText(raw){ return String(raw||"").split(/\r?\n/).map(l=>l.trim()).filter(l=>l!=="").join("\n"); }
function highlightUN(str){ return str.replace(/\b(UN\d+(?:,\d+)*)\b/g,'<span class="un">$1</span>'); }

/* weight logic */
function classifyWeight(kg){
  if(kg <= 15) return {cls:"weight-green", extra:""};
  if(kg <= 30) return {cls:"weight-yellow", extra:" (Pas på når du løfter)"};
  return {cls:"weight-red", extra:" (Brug hjælpe værktøj til løft)"};
}
function extractWeight(line){
  const m = line.match(/Vægt:\s*([\d.,]+)/i);
  if(!m) return null;
  return parseFloat(m[1].replace(",","."));
}

/* UI show/hide */
function showStartOnly(){
  startBtn.style.display = "inline-flex";
  newBtn.style.display = "none";
  copyBtn.disabled = (rawLines.innerText.trim()==="");
  scanStatus.textContent = "";
}
function showDuringScanning(){
  startBtn.style.display = "none";
  newBtn.style.display = "inline-flex";
  copyBtn.disabled = true;
  scanStatus.textContent = "SCANNING…";
}
function showAfterScan(){
  startBtn.style.display = "inline-flex";
  newBtn.style.display = "none";
  copyBtn.disabled = (rawLines.innerText.trim()==="");
  scanStatus.textContent = "";
}

/* render raw data */
function setRawData(raw){
  rawLines.innerHTML = "";
  hazardIcon.style.display = "none";

  const n = normalizeRawText(raw);
  if(!n){ copyBtn.disabled = true; return; }

  const lines = n.split(/\r?\n/);
  if(/\bUN\d+/.test(n)) hazardIcon.style.display = "block";

  lines.forEach(line=>{
    const div = document.createElement("div");
    let html = escapeHtml(line);
    html = highlightUN(html);

    if(/^Vægt:/i.test(line)){
      const kg = extractWeight(line);
      if(kg !== null){
        const info = classifyWeight(kg);
        div.classList.add(info.cls);
        html += escapeHtml(info.extra);
      }
    }

    div.innerHTML = html;
    rawLines.appendChild(div);
  });

  copyBtn.disabled = false;
}

/* copy function */
copyBtn.addEventListener("click", async ()=>{
  try{
    await navigator.clipboard.writeText(rawLines.innerText);
    const prev = copyBtn.innerText;
    copyBtn.innerText = "KOPIERET";
    setTimeout(()=>copyBtn.innerText = prev, 700);
  }catch(e){}
});

/* load jsQR */
function loadJsQr(){
  return new Promise((res, rej)=>{
    if(window.jsQR) return res(window.jsQR);
    const s = document.createElement("script");
    s.src = "https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js";
    s.onload = ()=>res(window.jsQR);
    s.onerror = ()=>rej();
    document.head.appendChild(s);
  });
}

/* camera handling */
async function startCamera(){
  if(!videoEl){
    videoEl = document.createElement("video");
    videoEl.setAttribute("playsinline","true");
  }
  if(!canvas){
    canvas = document.createElement("canvas");
    ctx = canvas.getContext("2d");
  }

  try{
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: "environment" } },
      audio: false
    });
    videoEl.srcObject = stream;
    await videoEl.play();

    cameraWrap.innerHTML = "";
    cameraWrap.appendChild(videoEl);
    return true;
  }catch(e){
    return false;
  }
}

function stopCamera(){
  if(rafId) { cancelAnimationFrame(rafId); rafId = null; }
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
    stream = null;
  }
  if(videoEl){
    try{ videoEl.pause(); }catch(e){}
    videoEl.srcObject = null;
  }
  cameraWrap.innerHTML = "Kamera er slukket";
}

/* scan loop */
async function scanLoop(){
  if(!videoEl || videoEl.readyState !== videoEl.HAVE_ENOUGH_DATA){
    rafId = requestAnimationFrame(scanLoop);
    return;
  }

  if(canvas.width !== videoEl.videoWidth){
    canvas.width = videoEl.videoWidth;
    canvas.height = videoEl.videoHeight;
  }

  ctx.drawImage(videoEl, 0, 0, canvas.width, canvas.height);
  const img = ctx.getImageData(0,0,canvas.width,canvas.height);

  let code = null;
  if(window.jsQR) code = jsQR(img.data, img.width, img.height);

  if(code && code.data){
    setRawData(code.data);
    scanning = false;
    stopCamera();
    showAfterScan();
    return;
  }

  rafId = requestAnimationFrame(scanLoop);
}

/* start scanning */
async function startScanning(){
  if(scanning) return;
  scanning = true;
  showDuringScanning();

  try{ await loadJsQr(); }catch(e){}

  const ok = await startCamera();
  if(!ok){
    const demo = "Demo\nVægt: 18 kg\nKemi: UN1209";
    setTimeout(()=>{ setRawData(demo); showAfterScan(); scanning=false; },600);
    return;
  }

  scanLoop();
}

/* new scanning (clears raw and restarts) */
async function newScanning(){
  // clear UI
  stopCamera();
  rawLines.innerHTML = "";
  hazardIcon.style.display = "none";
  copyBtn.disabled = true;

  scanStatus.textContent = "SCANNING…";
  showDuringScanning();

  await new Promise(r=>setTimeout(r,250));
  startScanning();
}

/* events */
startBtn.addEventListener("click", startScanning);
newBtn.addEventListener("click", newScanning);

/* show start state */
showStartOnly();

/* ensure camera stopped on unload */
window.addEventListener("beforeunload", stopCamera);
</script>
</body>
</html>
